## 分层概述

### 基本概念

TCP/IP协议族是一个四层协议系统，自底向上分别是数据链路层、网络层、传输层、应用层。

![](/static/images/2112/p007.jpeg)

- 数据链路层：实现了网卡接口的网络驱动程序，以处理数据在物理媒介（以太网、令牌环）上的传输。
  - 对上层隐藏的细节：不同的物理网络有不同的电气特性
  - 常见协议：ARP（用的多），RARP（用的少）：实现了IP地址和机器物理地址之间的相互转换；机器物理地址通常是MAC地址，以太网、令牌环、802.11无限局域网，都使用MAC地址
    - 需要注意的是：以太网、令牌环、802.11无线局域网，这些也属于本层，是本层的通信协议
  - 网络层使用IP地址寻找一台机器，数据链路层使用物理地址寻找一台机器，因此网络层必须先将目标机器的IP地址转换成物理地址，才能使用数据链路层提供的服务，这就是ARP协议的用途

![](/static/images/2112/p008.png)

- 网络层：网络层实现数据包的选路和转发。通信的两台主机一般不是直连的，而是通过多个中间节点（路由器）连接。网络层的任务就是选择这些中间节点，以确定两台主机之间的通信路径
  - 对上层隐藏的细节：隐藏了网络拓扑连接的细节，使得传输层和网络应用程序看来，通信的双方是直接相连的。
  - 本层主要协议：IP协议，ICMP协议（IP协议的补充，基于IP实现）
- 传输层：为两台主机的应用程序提供端到端的通信。与网络层使用的逐跳通信方式不同，传输层直关心通信的起始端和目的端，而不在乎数据包的中转过程。
- 应用层：负责处理应用程序的逻辑。
  - 上述三层都在内核空闲实现，本层主要在用户空间实现（少数在内核空间实现）。
  - 常见协议：ping程序（基于ICMP实现），telnet协议，OSPF协议（动态路由更新协议，路由器之间的通信），DNS协议

### 分层数据包名称

- 物理链路层
  - frame，帧
  - 传输媒介不同，帧的类型不同
    - 以太网：以太网帧，ethernet frame
    - 令牌环网：令牌环帧，token ring frame
  - 帧是最终在物理网络上传输的字节序列，是最基本的封装单元
- 网络层
  - ip datagram，ip数据报
- 传输层
  - tcp message segment，TCP报文段
  - udp datagram，UDP数据报

### 分层数据包大小限制

单独写到新的页面上

### 封装（encapsulation）与分用（demultiplexing）

封装

![](/static/images/2112/p009.jpeg)

分用

![](/static/images/2112/p010.jpeg)

- 数据链路层
  - 帧头部的类型字段，2B
    - IPv4: 0x0800
    - IPv6: 0x86DD
    - ARP: 0x0806
- 网络层
  - IP头部protocol字段，1B
    - TCP: 6
    - UDP: 17
- 传输层
  - TCP/UDP头部的端口号字段，2B

### 我的理解

- 物理链路层
  - 本层看起来是一个MAC到MAC的通信
  - 必须在同一个网络ID下进行；跨网络ID的ARP广播，会被丢弃，ARP广播会在本地网关终结
  - 如果需要进行跨网络ID的通信，需要将数据包发送给自己的网关，网关充当代理的角色，负责将数据包进行正确的转发
- 网络层
  - 本层看起来是一个IP到IP的通信
- 传输层
  - 本层看起来是一个端到端的通信


## 主要协议

### TCP

![](/static/images/2006/p015.png)

### UDP

![](/static/images/2006/p016.png)

### IP

![](/static/images/2006/p017.png)

### ICMP（Internet控制报文协议）

- ICMP经常被认为是IP层的一个组成部分，它传递差错报文以及其他需要注意的信息。
- ICMP报文通常被IP层或者更高层协议（TCP或者UDP）使用
- ICMP报文是在IP数据报内被传输的

![](/static/images/2101/p002.png)

![](/static/images/2101/p003.png)

### 概览

![](/static/images/2006/p013.png)

![](/static/images/2006/p014.png)

## 参考

- [http://www.colasoft.com.cn/download/protocols_map.php](http://www.colasoft.com.cn/download/protocols_map.php)
- [MTU和MSS的区别](https://blog.csdn.net/LoseInVain/article/details/53694265)
