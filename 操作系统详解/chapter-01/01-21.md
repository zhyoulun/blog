# 分页

在保护模式下运行时，IA-32 架构允许将线性地址空间直接映射到较大的物理内存（例如 4 GB 的 RAM），或者通过分页间接映射到较小的物理内存和磁盘存储中。后一种映射线性地址空间的方法通常称为**虚拟内存**或**按需分页虚拟内存**。

当使用分页时，处理器将线性地址空间划分为固定大小的页（长度为 4 KB、2 MB 或 4 MB），这些页可以映射到物理内存和/或磁盘存储中。当程序（或任务）引用内存中的逻辑地址时，处理器将该地址转换为线性地址，然后使用其分页机制将线性地址转换为相应的物理地址。

如果包含该线性地址的页当前不在物理内存中，处理器会生成一个**页错误异常（#PF）**。页错误异常的处理程序通常会指示操作系统或执行程序将页从磁盘存储加载到物理内存中（在此过程中可能会将物理内存中的另一个页写回磁盘）。当页被加载到物理内存后，从异常处理程序返回会导致生成异常的指令重新执行。处理器用于将线性地址映射到物理地址空间并生成页错误异常（必要时）的信息存储在内存中的页目录和页表中。

分页与分段的不同之处在于它使用固定大小的页。与段通常与其所包含的代码或数据结构大小相同不同，页的大小是固定的。如果仅使用分段作为地址转换的形式，物理内存中存在的数据结构的所有部分都会在内存中。如果使用分页，数据结构可以部分在内存中，部分在磁盘存储中。

为了最小化地址转换所需的总线周期数，最近访问的页目录和页表项会被缓存在处理器中的**转换后备缓冲区（TLB）**中。TLB 可以满足大多数读取当前页目录和页表的请求，而无需总线周期。额外的总线周期仅在 TLB 不包含页表项时发生，这通常发生在页长时间未被访问时。有关 TLB 的更多信息，请参见第 3.11 节“转换后备缓冲区（TLB）”。

---

### 关键点：
1. **分页机制**：
   - 将线性地址空间划分为固定大小的页（4 KB、2 MB 或 4 MB）。
   - 页可以映射到物理内存或磁盘存储中。
2. **页错误异常（#PF）**：
   - 当页不在物理内存中时触发。
   - 操作系统负责将页从磁盘加载到内存。
3. **页目录和页表**：
   - 存储线性地址到物理地址的映射信息。
4. **TLB（转换后备缓冲区）**：
   - 缓存最近访问的页目录和页表项，减少地址转换的总线周期。


## Paging Options

分页机制由处理器控制寄存器中的三个标志位控制：

- **PG（分页）标志**：CR0寄存器的第31位（从Intel386处理器开始的所有IA-32处理器均支持）。
- **PSE（页大小扩展）标志**：CR4寄存器的第4位（在Pentium处理器中引入）。
- **PAE（物理地址扩展）标志**：CR4寄存器的第5位（在Pentium Pro处理器中引入）。

**PG标志**用于启用页转换机制。操作系统或执行程序通常在处理器初始化期间设置此标志。如果处理器需要使用页转换机制来实现按需分页的虚拟内存系统，或者操作系统设计为在虚拟8086模式下运行多个程序（或任务），则必须设置PG标志。

**PSE标志**用于启用大页大小：4MB页或2MB页（当PAE标志被设置时）。当PSE标志被清除时，使用更常见的4KB页大小。有关PSE标志使用的更多信息，请参见第3.7.2节“线性地址转换（4MB页）”、第3.8.2节“启用PAE时的线性地址转换（2MB页）”以及第3.9节“使用PSE-36分页机制的36位物理寻址”。

**PAE标志**提供了一种将物理地址扩展到36位的方法。这种物理地址扩展只能在分页启用时使用。它依赖于一个额外的页目录指针表，该表与页目录和页表一起用于引用高于FFFFFFFFH的物理地址。有关使用PAE标志扩展物理地址的更多信息，请参见第3.8节“使用PAE分页机制的36位物理寻址”。

36位页大小扩展（PSE-36）功能提供了另一种将物理寻址扩展到36位的方法。此分页机制使用页大小扩展模式（通过PSE标志启用）和修改后的页目录条目来引用高于FFFFFFFFH的物理地址。PSE-36功能标志（当执行CPUID指令且源操作数为1时，EDX寄存器的第17位）指示此寻址机制的可用性。有关PSE-36物理地址扩展和页大小扩展机制的更多信息，请参见第3.9节“使用PSE-36分页机制的36位物理寻址”。

## Page Tables and Directories

处理器用于将线性地址转换为物理地址的信息（在启用分页时）包含在以下四种数据结构中：

- **页目录**：一个包含32位页目录项（PDEs）的数组，存储在一个4KB的页中。一个页目录最多可以包含1024个页目录项。
- **页表**：一个包含32位页表项（PTEs）的数组，存储在一个4KB的页中。一个页表最多可以包含1024个页表项。（对于2MB或4MB的页，不使用页表。这些页大小直接从页目录项映射。）
- **页**：一个4KB、2MB或4MB的平坦地址空间。
- **页目录指针表**：一个包含四个64位项的数组，每个项指向一个页目录。此数据结构仅在启用物理地址扩展时使用（参见第3.8节“使用PAE分页机制的36位物理寻址”）。

这些表在正常32位物理寻址时提供对4KB或4MB页的访问，而在扩展（36位）物理寻址时提供对4KB、2MB或4MB页的访问。表3-3展示了从分页控制标志和PSE-36 CPUID功能标志的不同设置中获得的页大小和物理地址大小。每个页目录项包含一个PS（页大小）标志，用于指定该项是指向一个页表（其项依次指向4KB页，PS设置为0），还是直接指向一个4MB页（PSE和PS设置为1）或2MB页（PAE和PS设置为1）。
