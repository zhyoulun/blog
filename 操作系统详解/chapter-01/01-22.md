# PAGE TRANSLATION USING 32-BIT PHYSICAL ADDRESSING

以下部分描述了在使用 32 位物理地址且最大物理地址空间为 4GB 时，IA-32 架构的页转换机制。第 3.8 节 “使用 PAE 分页机制的 36 位物理寻址” 和第 3.9 节 “使用 PSE-36 分页机制的 36 位物理寻址” 描述了对此页转换机制的扩展，以支持 36 位物理地址和最大物理地址空间为 64GB 的情况。

![](/static/images/2502/p014.png)

## Linear Address Translation (4-KByte Pages)

![](/static/images/2502/p015.png)

图3-12展示了将线性地址映射到4KB页时的页目录和页表层次结构。页目录中的项指向页表，而页表中的项指向物理内存中的页。这种分页方法可用于寻址多达2^20个页，覆盖2^32字节（4GB）的线性地址空间。

为了选择不同的表项，线性地址被划分为三个部分：
- **页目录项**：第22位到第31位提供页目录中某个项的偏移量。选中的项提供页表的基物理地址。
- **页表项**：线性地址的第12位到第21位提供所选页表中某个项的偏移量。该条目提供物理内存中页的基物理地址。
- **页偏移量**：第0位到第11位提供页内物理地址的偏移量。

内存管理软件可以选择为所有程序和任务使用一个页目录，为每个任务使用一个页目录，或者两者的某种组合。

## Linear Address Translation (4-MByte Pages)

![](/static/images/2502/p016.png)

图3-12展示了如何使用页目录将线性地址映射到4MB页。页目录中的项指向物理内存中的4MB页。这种分页方法可用于将多达1024个页映射到4GB的线性地址空间中。

通过在控制寄存器CR4中设置PSE标志并在页目录项中设置页大小（PS）标志（参见图3-14），可以选择4MB页大小。当这些标志被设置时，线性地址被划分为两个部分：
- **页目录项**：第22位到第31位提供页目录中某个项的偏移量。选中的项提供4MB页的基物理地址。
- **页偏移量**：第0位到第21位提供页内物理地址的偏移量。

**注意**  
（仅针对Pentium处理器。）在启用或禁用大页大小时，必须在设置或清除控制寄存器CR4中的PSE标志后使TLB无效（刷新）。否则，由于处理器使用TLB中存储的过时页转换信息，可能会导致错误的页转换。有关如何使TLB无效的信息，请参见第10.9节“使转换后备缓冲器（TLB）无效”。

## Mixing 4-KByte and 4-MByte Pages

当CR4寄存器中的PSE标志被设置时，可以从同一个页目录中访问4MB页和用于4KB页的页表。如果PSE标志被清除，则只能访问用于4KB页的页表（无论页目录项中的PS标志如何设置）。

混合使用4KB页和4MB页的一个典型示例是将操作系统或执行程序的内核放置在大页中，以减少TLB未命中，从而提高整体系统性能。处理器在单独的TLB中维护4MB页项和4KB页项。因此，将诸如内核之类的常用代码放置在大页中，可以为应用程序和任务释放4KB页的TLB项。

## Memory Aliasing

IA-32 架构允许内存别名化，即允许两个页目录项指向同一个页表项。需要以这种方式实现内存别名化的软件必须管理页目录项和页表项中访问位和脏位的一致性。如果允许两个页目录项的访问位和脏位不一致，可能会导致处理器死锁。

## Base Address of the Page Directory

当前页目录的物理地址存储在CR3寄存器中（也称为页目录基址寄存器或PDBR）。（有关PDBR的更多信息，请参见图2-5和第2.5节“控制寄存器”。）如果要使用分页，PDBR必须作为处理器初始化过程的一部分被加载（在启用分页之前）。随后，PDBR可以通过使用MOV指令显式加载新值到CR3来更改，或者作为任务切换的一部分隐式更改。（有关如何为任务设置CR3寄存器内容的描述，请参见第6.2.1节“任务状态段（TSS）”。）

PDBR中没有用于页目录的存在标志。当相关任务被挂起时，页目录可能不存在（被换出物理内存），但操作系统必须确保在任务被调度之前，任务TSS中PDBR映像指示的页目录存在于物理内存中。只要任务处于活动状态，页目录也必须保留在内存中。

## Page-Directory and Page-Table Entries

![](/static/images/2502/p017.png)

![](/static/images/2502/p018.png)

图3-14展示了使用4KB页和32位物理地址时，页目录项和页表项的格式。图3-15展示了使用4MB页和32位物理地址时，页目录项的格式。图3-14和图3-15中各项的标志和字段的功能如下：

**页基地址（第12位到第32位）**  
- **（用于4KB页的页表项）**：指定4KB页的第一个字节的物理地址。该字段的位被解释为物理地址的最高20位，强制页在4KB边界对齐。  
- **（用于4KB页表的页目录项）**：指定页表的第一个字节的物理地址。该字段的位被解释为物理地址的最高20位，强制页表在4KB边界对齐。  
- **（用于4MB页的页目录项）**：指定4MB页的第一个字节的物理地址。仅使用该字段的第22位到第31位（对于Pentium II及更早的IA-32处理器，第12位到第21位被保留且必须设置为0）。基地址位被解释为物理地址的最高10位，强制4MB页在4MB边界对齐。

**存在（P）标志（第0位）**  
指示该条目所指向的页或页表当前是否已加载到物理内存中。当该标志被设置时，页在物理内存中，地址转换正常进行。当该标志被清除时，页不在内存中，如果处理器尝试访问该页，则会生成页错误异常（#PF）。  
处理器不会设置或清除该标志；由操作系统或执行程序维护该标志的状态。  
如果处理器生成页错误异常，操作系统通常需要执行以下操作：  
1. 将页从磁盘存储复制到物理内存。  
2. 将页地址加载到页表或页目录项中并设置其存在标志。此时可能还会设置其他标志，如脏位和访问位。  
3. 使TLB中的当前页表项无效（有关TLB及其无效化的讨论，请参见第3.11节“转换后备缓冲器（TLB）”）。  
4. 从页错误处理程序返回以重新启动被中断的程序（或任务）。

**读/写（R/W）标志（第1位）**  
指定页或页组（在指向页表的页目录项的情况下）的读写权限。当该标志被清除时，页为只读；当该标志被设置时，页可读写。  
该标志与CR0寄存器中的U/S标志和WP标志交互。有关这些标志使用的详细讨论，请参见第4.11节“页级保护”和表4-2。

**用户/超级用户（U/S）标志（第2位）**  
指定页或页组（在指向页表的页目录项的情况下）的用户/超级用户权限。当该标志被清除时，页被分配为超级用户权限级别；当该标志被设置时，页被分配为用户权限级别。该标志与R/W标志和CR0寄存器中的WP标志交互。有关这些标志使用的详细讨论，请参见第4.11节“页级保护”和表4-2。

**页级写通（PWT）标志（第3位）**  
控制单个页或页表的写通或写回缓存策略。当PWT标志被设置时，启用相关页或页表的写通缓存；当该标志被清除时，启用相关页或页表的写回缓存。如果CR0中的CD（缓存禁用）标志被设置，处理器会忽略该标志。有关该标志使用的更多信息，请参见第10.5节“缓存控制”。有关控制寄存器CR3中的PWT标志的描述，请参见第2.5节“控制寄存器”。

**页级缓存禁用（PCD）标志（第4位）**  
控制单个页或页表的缓存。当PCD标志被设置时，禁止相关页或页表的缓存；当该标志被清除时，相关页或页表可被缓存。该标志允许为包含内存映射I/O端口的页或缓存后无法提高性能的页禁用缓存。如果CR0中的CD（缓存禁用）标志被设置，处理器会忽略该标志（假设其被设置）。有关该标志使用的更多信息，请参见第10章“内存缓存控制”。有关控制寄存器CR3中的PCD标志的描述，请参见第2.5节“控制寄存器”。

**访问（A）标志（第5位）**  
当被设置时，指示页或页表已被访问（读取或写入）。内存管理软件通常在页或页表最初加载到物理内存时清除该标志。处理器在第一次访问页或页表时设置该标志。该标志是一个“粘性”标志，意味着一旦被设置，处理器不会隐式清除它。只有软件可以清除该标志。  
访问位和脏位供内存管理软件用于管理页和页表在物理内存中的调入和调出。

**脏（D）标志（第6位）**  
当被设置时，指示页已被写入。（该标志不用于指向页表的页目录项。）内存管理软件通常在页最初加载到物理内存时清除该标志。处理器在第一次对页执行写操作时设置该标志。  
该标志是“粘性”的，意味着一旦被设置，处理器不会隐式清除它。只有软件可以清除该标志。脏位和访问位供内存管理软件用于管理页和页表在物理内存中的调入和调出。

**页大小（PS）标志（第7位，用于4KB页的页目录项）**  
确定页大小。当该标志被清除时，页大小为4KB，页目录项指向页表。当该标志被设置时，对于正常的32位寻址，页大小为4MB（如果启用扩展物理寻址，则为2MB），页目录项指向页。如果页目录项指向页表，则与该页表关联的所有页均为4KB页。

**页属性表索引（PAT）标志（第7位，用于4KB页的页表项；第12位，用于4MB页的页目录项）**  
（在Pentium III处理器中引入。）选择PAT条目。对于支持页属性表（PAT）的处理器，该标志与PCD和PWT标志一起用于选择PAT中的条目，从而选择页的内存类型（参见第10.12节“页属性表（PAT）”）。对于不支持PAT的处理器，该位被保留且应设置为0。

**全局（G）标志（第8位）**  
（在Pentium Pro处理器中引入。）当被设置时，指示全局页。当页被标记为全局且CR4寄存器中的页全局启用（PGE）标志被设置时，加载CR3寄存器或发生任务切换时，页表或页目录项不会在TLB中无效。该标志用于防止频繁使用的页（如包含内核或其他操作系统或执行程序代码的页）从TLB中被刷新。只有软件可以设置或清除该标志。对于指向页表的页目录项，该标志被忽略，页的全局特性在页表项中设置。有关该标志使用的更多信息，请参见第3.11节“转换后备缓冲器（TLB）”。（该位在Pentium及更早的IA-32处理器中被保留。）

**保留和软件可用位**  
- **对于所有IA-32处理器**：第9位、第10位和第11位可供软件使用。（当存在位被清除时，第1位到第31位可供软件使用——参见图3-16。）在指向页表的页目录项中，第6位被保留且应设置为0。当控制寄存器CR4中的PSE和PAE标志被设置时，如果保留位未设置为0，处理器会生成页错误。  
- **对于Pentium II及更早的处理器**：页表项中的第7位被保留且应设置为0。对于4MB页的页目录项，第12位到第21位被保留且必须设置为0。  
- **对于Pentium III及之后的处理器**：对于4MB页的页目录项，第13位到第21位被保留且必须设置为0。

## Not Present Page-Directory and Page-Table Entries

![](/static/images/2502/p019.png)

当页表项或页目录项的存在标志被清除时，操作系统或执行程序可以使用该条目的其余部分存储信息，例如页在磁盘存储系统中的位置（参见图3-16）。