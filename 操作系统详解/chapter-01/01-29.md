# TYPE CHECKING

段描述符在两个位置包含类型信息：
- **S（描述符类型）标志**。
- **类型字段**。

处理器使用此信息来检测编程错误，这些错误导致尝试以不正确或非预期的方式使用段或门。

**S标志**指示描述符是系统类型还是代码或数据类型。类型字段提供4个附加位，用于定义各种类型的代码、数据和系统描述符。表3-1显示了代码和数据描述符的类型字段编码；表3-2显示了系统描述符的字段编码。

处理器在对段选择子和段描述符进行操作时会检查类型信息。以下列表给出了执行类型检查的典型操作示例。此列表并不详尽。

- **当段选择子加载到段寄存器时**。某些段寄存器只能包含特定类型的描述符，例如：
  - CS寄存器只能加载代码段的段选择子。
  - 不可读的代码段或系统段的段选择子不能加载到数据段寄存器（DS、ES、FS和GS）中。
  - 只有可写数据段的段选择子可以加载到SS寄存器中。

- **当段选择子加载到LDTR或任务寄存器时**：
  - LDTR只能加载LDT的段选择子。
  - 任务寄存器只能加载TSS的段选择子。

- **当指令访问描述符已加载到段寄存器中的段时**。某些段只能以某些预定义的方式被指令使用，例如：
  - 任何指令都不能写入可执行段。
  - 如果数据段不可写，任何指令都不能写入数据段。
  - 除非设置了可读标志，否则任何指令都不能读取可执行段。

- **当指令操作数包含段选择子时**。某些指令只能访问特定类型的段或门，例如：
  - 远CALL或远JMP指令只能访问符合代码段、非符合代码段、调用门、任务门或TSS的段描述符。
  - LLDT指令必须引用LDT的段描述符。
  - LTR指令必须引用TSS的段描述符。
  - LAR指令必须引用LDT、TSS、调用门、任务门、代码段或数据段的段或门描述符。
  - LSL指令必须引用LDT、TSS、代码段或数据段的段描述符。
  - IDT条目必须是中断门、陷阱门或任务门。

- **在某些内部操作期间**。例如：
  - 在远调用或远跳转（通过远CALL或远JMP指令执行）时，处理器通过检查段（或门）选择子所指向的段（或门）描述符中的类型字段来确定要执行的控制转移类型（调用或跳转到另一个代码段、通过门调用或跳转，或任务切换）。如果描述符类型是代码段或调用门，则指示调用或跳转到另一个代码段；如果描述符类型是TSS或任务门，则指示任务切换。
  - 在通过调用门调用或跳转时（或通过陷阱或中断门调用中断或异常处理程序时），处理器会自动检查门所指向的段描述符是否为代码段。
  - 在通过任务门调用或跳转到新任务时（或通过任务门调用中断或异常处理程序到新任务时），处理器会自动检查任务门所指向的段描述符是否为TSS。
  - 在通过直接引用TSS调用或跳转到新任务时，处理器会自动检查CALL或JMP指令所指向的段描述符是否为TSS。
  - 在从嵌套任务返回（由IRET指令启动）时，处理器会检查当前TSS中的前一个任务链接字段是否指向TSS。

## Null Segment Selector Checking

尝试将空段选择子（参见第 3.4.1 节 “段选择子”）加载到 CS 或 SS 段寄存器中会生成一般保护异常（#GP）。空段选择子可以加载到 DS、ES、FS 或 GS 寄存器中，但当这些寄存器加载了空段选择子时，任何尝试通过它们访问段的操作都会导致生成 #GP 异常。将未使用的数据段寄存器加载为空段选择子是一种检测对未使用段寄存器的访问和 / 或防止对数据段的不必要访问的有用方法。
