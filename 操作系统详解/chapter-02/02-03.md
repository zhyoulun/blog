- APIC，Advanced Programmable Interrupt Controller，高级可编程中断控制器
- 8259 PIC，可编程中断控制器

APIC（高级可编程中断控制器）是一种用于管理和分发中断的硬件组件，主要用于多处理器（多核）系统，以提高中断处理的效率和灵活性。它是**传统 8259 PIC（可编程中断控制器）**的增强版本，支持更复杂的中断管理功能。

1. 为什么需要 APIC？

在早期计算机中，单个 8259 PIC（可编程中断控制器）被用来管理中断。但是，随着计算机处理器数量的增加，8259 PIC 面临了以下问题：

- 支持的中断数量有限（最多 15 个），不适用于复杂的多设备环境。
- 多处理器系统中不能高效管理中断，导致 CPU 之间的中断处理协调变得困难。
- 中断优先级管理能力较弱，影响系统的实时性和响应速度。

为了解决这些问题，APIC 设计用于多处理器系统，提供更高效的中断处理能力。

2. APIC 组成

APIC 主要由两个部分组成：

（1）本地 APIC（LAPIC，Local APIC）
- 每个 CPU 或 CPU 核心都有一个本地 APIC。
- 负责处理该 CPU 上的中断，并与 I/O APIC 进行通信。
- 允许 CPU 之间发送中断（IPI，Inter-Processor Interrupts）。
- 支持更灵活的优先级管理。

（2）I/O APIC（输入/输出 APIC）
- 负责管理外部设备（如键盘、鼠标、网络卡等）产生的中断，并将它们发送到合适的 CPU。
- 支持 24-64 个中断输入，远超 8259 PIC 的 15 个中断。
- 提供中断重映射功能，可以动态分配中断给不同的 CPU。

3. APIC 的工作方式

（1）中断的产生与传递
- 外部设备发送中断
例如，键盘或网卡产生一个中断信号，发送到 I/O APIC。
- I/O APIC 处理中断并选择目标 CPU
I/O APIC 通过中断表决定将中断发送到哪个 CPU 的本地 APIC。
- 本地 APIC 接收中断并通知 CPU
CPU 响应中断并执行相应的中断处理程序。
- CPU 处理完成后发送中断结束信号（EOI）
本地 APIC 通知 I/O APIC 中断处理已完成，系统恢复正常工作。

（2）处理器间中断（IPI, Inter-Processor Interrupt）
- APIC 允许 CPU 之间发送中断，常用于同步任务，比如让其他 CPU 刷新缓存或执行特定任务。


4. APIC 模式

APIC 主要支持以下几种中断模式：
- 边沿触发模式（Edge-Triggered）：当电平信号从低变高时触发中断。
- 电平触发模式（Level-Triggered）：当信号维持高电平时，会持续触发中断，直到设备清除中断状态。
- 固定模式（Fixed Mode）：中断发送到特定 CPU。
- 最低优先级模式（Lowest Priority Mode）：中断发送到优先级最低的 CPU，减少高负载 CPU 的中断压力。
- 轮询模式（Round Robin Mode）：中断在多个 CPU 之间轮流分配，均衡负载。


5. APIC 与 8259 PIC 的对比

| 特性 | 	APIC| 	8259 PIC | 
|--|--|--|
| 中断源数量	| 24-64 个	| 最多 15 个| 
| 多处理器支持| 	是	| 否| 
| 中断优先级	| 可配置多个优先级	| 仅支持基本优先级| 
| 中断重定向	| 是	| 否| 
| 处理器间中断（IPI）| 	是	| 否| 

6. APIC 在现代 CPU 中的应用

- Intel x86 和 AMD 处理器 都集成了本地 APIC。
- 现代操作系统（如 Windows、Linux、macOS） 都支持 APIC，以提高中断处理性能。
- 虚拟化技术（如 VMware、KVM） 也利用 APIC 来高效管理虚拟机的中断。

