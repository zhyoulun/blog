# TASK MANAGEMENT OVERVIEW

任务是处理器可以调度、执行和暂停的工作单元。它可以用于执行程序、任务或进程、操作系统服务实用程序、中断或异常处理程序，或者内核或执行实用程序。

IA-32 架构提供了一种机制，用于保存任务的状态、调度任务执行以及从一个任务切换到另一个任务。在保护模式下运行时，所有处理器的执行都在任务内进行。即使是简单的系统也必须至少定义一个任务。更复杂的系统可以使用处理器的任务管理功能来支持多任务应用程序。

## Task Structure

任务由两部分组成：任务执行空间和任务状态段（TSS）。任务执行空间由代码段、堆栈段和一个或多个数据段组成（参见图 6-1）。如果操作系统或执行程序使用处理器的特权级别保护机制，任务执行空间还会为每个特权级别提供一个单独的堆栈。

TSS 指定了构成任务执行空间的段，并为任务状态信息提供了存储空间。在多任务系统中，TSS 还提供了任务链接的机制。

**注意：**  
本章主要描述 32 位任务和 32 位 TSS 结构。有关 16 位任务和 16 位 TSS 结构的信息，请参见第 6.6 节“16 位任务状态段（TSS）”。

任务由其 TSS 的段选择子标识。当任务被加载到处理器中执行时，TSS 的段选择子、基地址、限制和段描述符属性会被加载到任务寄存器中（参见第 2.4.4 节“任务寄存器（TR）”）。

如果为任务实现了分页，则任务使用的页目录的基地址会被加载到控制寄存器 **CR3** 中。

![](/static/images/2502/p051.png)


## Task State

以下项目定义了当前执行任务的状态：
- 任务的当前执行空间，由段寄存器（**CS**、**DS**、**SS**、**ES**、**FS** 和 **GS**）中的段选择子定义。  
- 通用寄存器的状态。  
- **EFLAGS** 寄存器的状态。  
- **EIP** 寄存器的状态。  
- 控制寄存器 **CR3** 的状态。  
- 任务寄存器的状态。  
- **LDTR** 寄存器的状态。  
- I/O 映射基地址和 I/O 映射（包含在 TSS 中）。  
- 指向特权级别 0、1 和 2 堆栈的堆栈指针（包含在 TSS 中）。  
- 指向先前执行任务的链接（包含在 TSS 中）。  

在调度任务之前，所有这些项目（除了任务寄存器的状态）都包含在任务的 TSS 中。此外，**LDTR** 寄存器的完整内容不包含在 TSS 中，仅包含 LDT 的段选择子。

## Executing a Task

软件或处理器可以通过以下方式之一调度任务执行：
- 使用 **CALL** 指令显式调用任务。  
- 使用 **JMP** 指令显式跳转到任务。  
- 处理器隐式调用中断处理程序任务。  
- 隐式调用异常处理程序任务。  
- 当 **EFLAGS** 寄存器中的 **NT** 标志被设置时，通过 **IRET** 指令启动的返回。  

所有这些调度任务的方法都通过指向任务门或任务 TSS 的段选择子来标识要调度的任务。当使用 **CALL** 或 **JMP** 指令调度任务时，指令中的选择子可以直接选择 TSS，也可以选择包含 TSS 选择子的任务门。当调度任务处理中断或异常时，中断或异常的 IDT 条目必须包含一个任务门，该任务门保存中断或异常处理程序 TSS 的选择子。

当任务被调度执行时，当前运行的任务与被调度的任务之间会自动发生任务切换。在任务切换期间，当前执行任务（称为任务的状态或上下文）的执行环境被保存到其 TSS 中，任务的执行被暂停。然后，被调度任务的上下文被加载到处理器中，该任务的执行从新加载的 **EIP** 寄存器指向的指令开始。如果任务自上次系统初始化以来尚未运行，**EIP** 将指向任务代码的第一条指令；否则，它将指向任务上次活动时执行的最后一条指令之后的下一条指令。

如果当前执行的任务（调用任务）调用了被调度的任务（被调用任务），则调用任务的 TSS 段选择子会存储在被调用任务的 TSS 中，以提供返回调用任务的链接。

对于所有 IA-32 处理器，任务不可递归。任务不能调用或跳转到自身。

中断和异常可以通过任务切换到处理程序任务来处理。在这里，处理器不仅可以执行任务切换来处理中断或异常，还可以在从中断或异常处理程序任务返回时自动切换回被中断的任务。这种机制可以处理在中断任务期间发生的中断。

作为任务切换的一部分，处理器还可以切换到另一个 LDT，允许每个任务对基于 LDT 的段具有不同的逻辑到物理地址映射。页目录基址寄存器（**CR3**）也会在任务切换时重新加载，允许每个任务拥有自己的页表集。这些保护机制有助于隔离任务并防止它们相互干扰。如果不使用这些保护机制中的一个或两个，处理器不会在任务之间提供保护。即使在使用多个特权级别进行保护的操作系统中也是如此。在这里，运行在特权级别 3 的任务如果使用与其他特权级别 3 任务相同的 LDT 和页表，则可以访问代码并破坏其他任务的数据和堆栈。

使用任务管理功能处理多任务应用程序是可选的。多任务可以在软件中处理，每个软件定义的任务在单个 IA-32 架构任务的上下文中执行。