# TASK MANAGEMENT DATA STRUCTURES

处理器定义了五个数据结构来处理与任务相关的活动：
- **任务状态段（TSS）**。  
- **任务门描述符**。  
- **TSS 描述符**。  
- **任务寄存器**。  
- **EFLAGS 寄存器中的 NT 标志**。  

在保护模式下运行时，必须为至少一个任务创建 TSS 和 TSS 描述符，并且必须将 TSS 的段选择子加载到任务寄存器中（使用 **LTR** 指令）。

## Task-State Segment (TSS)

恢复任务所需的处理器状态信息保存在称为任务状态段（TSS）的系统段中。图 6-2 显示了为 32 位 CPU 设计的任务的 TSS 格式。（与 16 位 Intel 286 处理器任务的兼容性通过另一种 TSS 提供，参见图 6-9。）TSS 的字段分为两大类：动态字段和静态字段。

![](/static/images/2502/p052.png)

在任务切换期间挂起任务时，处理器会更新动态字段。以下是动态字段：  
- **通用寄存器字段**：任务切换前 **EAX**、**ECX**、**EDX**、**EBX**、**ESP**、**EBP**、**ESI** 和 **EDI** 寄存器的状态。  
- **段选择子字段**：任务切换前存储在 **ES**、**CS**、**SS**、**DS**、**FS** 和 **GS** 寄存器中的段选择子。  
- **EFLAGS 寄存器字段**：任务切换前 **EFLAGS** 寄存器的状态。  
- **EIP（指令指针）字段**：任务切换前 **EIP** 寄存器的状态。  
- **前一任务链接字段**：包含前一任务的 TSS 段选择子（在由调用、中断或异常启动的任务切换时更新）。此字段（有时称为反向链接字段）允许通过 **IRET** 指令启动返回前一任务的任务切换。  

处理器读取静态字段，但通常不会更改它们。这些字段在任务创建时设置。以下是静态字段：  
- **LDT 段选择子字段**：包含任务的 LDT 段选择子。  
- **CR3 控制寄存器字段**：包含任务使用的页目录的基物理地址。控制寄存器 **CR3** 也称为页目录基址寄存器（PDBR）。  
- **特权级别 0、1 和 2 堆栈指针字段**：这些堆栈指针由堆栈段的段选择子（**SS0**、**SS1** 和 **SS2**）和堆栈中的偏移量（**ESP0**、**ESP1** 和 **ESP2**）组成的逻辑地址。请注意，这些字段的值对于特定任务是静态的；而如果任务内发生堆栈切换，**SS** 和 **ESP** 的值将发生变化。  
- **T（调试陷阱）标志（字节 100，位 0）**：当设置为 1 时，**T** 标志会导致处理器在切换到该任务时引发调试异常（参见第 15.3.1.5 节“任务切换异常条件”）。  
- **I/O 映射基地址字段**：包含从 TSS 基址到 I/O 权限位图和中断重定向位图的 16 位偏移量。如果存在，这些映射存储在 TSS 的更高地址处。I/O 映射基地址指向 I/O 权限位图的开始和中断重定向位图的结束。有关 I/O 权限位图的更多信息，请参见《IA-32 Intel 架构软件开发人员手册》第 1 卷第 12 章“输入/输出”。有关中断重定向位图的详细说明，请参见第 16.3 节“虚拟 8086 模式中的中断和异常处理”。  

如果使用分页，应注意避免在任务切换期间处理器读取的 TSS 部分（前 104 字节）内放置页边界。如果在此部分 TSS 内放置了页边界，则边界两侧的页必须同时存在并且在物理内存中连续。  

此限制的原因是，在任务切换期间访问 TSS 时，处理器从 TSS 的第一个字节的物理地址开始，从连续的物理地址读取和写入每个 TSS 的前 104 字节。如果在此区域内发生页边界，处理器可能不会执行地址转换。因此，在 TSS 访问开始后，如果 104 字节的某部分不存在或物理上不连续，处理器将访问错误的 TSS 信息，而不会生成页错误异常。读取此错误信息通常会导致任务切换过程中稍后出现不可恢复的异常。  

此外，如果使用分页，则前一任务的 TSS、当前任务的 TSS 以及每个任务的描述符表条目对应的页应标记为读/写。如果在任务切换启动之前，包含这些结构的页也存在于内存中，则任务切换将更快完成。


## TSS Descriptor

TSS 与所有其他段一样，由段描述符定义。图 6-3 显示了 TSS 描述符的格式。TSS 描述符只能放置在 GDT 中；它们不能放置在 LDT 或 IDT 中。

尝试使用设置了 **TI** 标志（指示当前 LDT）的段选择子访问 TSS 会导致在 **CALL** 和 **JMP** 期间生成一般保护异常（#GP）；在 **IRET** 期间会导致无效 TSS 异常（#TS）。如果尝试将 TSS 的段选择子加载到段寄存器中，也会生成一般保护异常。

类型字段中的忙标志（**B**）指示任务是否忙。忙任务当前正在运行或已挂起。类型字段值为 1001B 表示非活动任务；值为 1011B 表示忙任务。任务不可递归。处理器使用忙标志来检测尝试调用执行已被中断的任务。为了确保只有一个忙标志与任务关联，每个 TSS 应只有一个指向它的 TSS 描述符。


![](/static/images/2502/p053.png)

基址、限制和 **DPL** 字段以及粒度标志和存在标志的功能与它们在数据段描述符中的使用类似（参见第 3.4.3 节“段描述符”）。当 32 位 TSS 的 TSS 描述符中的 **G** 标志为 0 时，限制字段的值必须等于或大于 67H，即比 TSS 的最小大小少一个字节。尝试切换到 TSS 描述符限制小于 67H 的任务会生成无效 TSS 异常（#TS）。如果 TSS 中包含 I/O 权限位图，则需要更大的限制。如果操作系统在 TSS 中存储了额外的数据，则需要更大的限制。处理器在任务切换时不检查大于 67H 的限制；但在访问 I/O 权限位图或中断重定向位图时会检查。

任何可以访问 TSS 描述符的程序或过程（即其 **CPL** 数值上等于或小于 TSS 描述符的 **DPL**）都可以通过调用或跳转调度任务。在大多数系统中，TSS 描述符的 **DPL** 应设置为小于 3 的值，以便只有特权软件可以执行任务切换。然而，在多任务应用程序中，某些 TSS 描述符的 **DPL** 可以设置为 3，以允许在应用程序（或用户）特权级别进行任务切换。

## Task Register

任务寄存器保存当前任务的 TSS 的 16 位段选择子和整个段描述符（32 位基地址、16 段限制和描述符属性）（参见图 2-4）。此信息从当前任务的 GDT 中的 TSS 描述符复制。图 6-4 显示了处理器使用任务寄存器中的信息访问 TSS 的路径。

任务寄存器既有可见部分（可由软件读取和更改）也有不可见部分（由处理器维护且软件无法访问）。可见部分中的段选择子指向 GDT 中的 TSS 描述符。处理器使用任务寄存器的不可见部分来缓存 TSS 的段描述符。将这些值缓存在寄存器中可以使任务的执行更高效，因为处理器不需要从内存中获取这些值来引用当前任务的 TSS。

**LTR**（加载任务寄存器）和 **STR**（存储任务寄存器）指令加载和读取任务寄存器的可见部分。**LTR** 指令将指向 GDT 中 TSS 描述符的段选择子（源操作数）加载到任务寄存器中，然后使用 TSS 描述符中的信息加载任务寄存器的不可见部分。此指令是特权指令，只能在 **CPL** 为 0 时执行。**LTR** 指令通常用于系统初始化期间，以在任务寄存器中放入初始值。之后，当发生任务切换时，任务寄存器的内容会隐式更改。

**STR**（存储任务寄存器）指令将任务寄存器的可见部分存储到通用寄存器或内存中。此指令可由在任何特权级别运行的代码执行，以识别当前运行的任务；然而，它通常仅由操作系统软件使用。

在处理器上电或复位时，段选择子和基地址设置为默认值 0，限制设置为 FFFFH。

## Task-Gate Descriptor

任务门描述符提供了对任务的间接、受保护的引用。图 6-5 显示了任务门描述符的格式。任务门描述符可以放置在 GDT、LDT 或 IDT 中。

任务门描述符中的 TSS 段选择子字段指向 GDT 中的 TSS 描述符。此段选择子中的 **RPL** 不使用。

任务门描述符的 **DPL** 控制在任务切换期间对 TSS 描述符的访问。当程序或过程通过任务门调用或跳转到任务时，指向任务门的门选择子的 **CPL** 和 **RPL** 字段必须小于或等于任务门描述符的 **DPL**。（请注意，当使用任务门时，目标 TSS 描述符的 **DPL** 不使用。）

![](/static/images/2502/p054.png)

![](/static/images/2502/p055.png)

任务可以通过任务门描述符或 TSS 描述符访问。提供这两种结构是为了满足以下需求：
- **任务只需一个忙标志的需求**。因为任务的忙标志存储在 TSS 描述符中，所以每个任务应该只有一个 TSS 描述符。然而，可能有多个任务门引用同一个 TSS 描述符。  
- **提供对任务的选择性访问的需求**。任务门满足这一需求，因为它们可以驻留在 LDT 中，并且可以具有与 TSS 描述符的 **DPL** 不同的 **DPL**。没有足够特权访问 GDT 中任务的 TSS 描述符（通常 **DPL** 为 0）的程序或过程，可能被允许通过具有更高 **DPL** 的任务门访问该任务。任务门为操作系统提供了更大的自由度，以限制对特定任务的访问。  
- **需要由独立任务处理中断或异常的需求**。任务门也可以驻留在 IDT 中，这允许中断和异常由处理程序任务处理。当中断或异常向量指向任务门时，处理器切换到指定任务。  

图 6-6 说明了 LDT 中的任务门、GDT 中的任务门和 IDT 中的任务门如何指向同一任务。