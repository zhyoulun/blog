#  TASK SWITCHING

处理器在以下四种情况下将执行转移到另一个任务：
- 当前程序、任务或过程执行 **JMP** 或 **CALL** 指令跳转到 GDT 中的 TSS 描述符。  
- 当前程序、任务或过程执行 **JMP** 或 **CALL** 指令跳转到 GDT 或当前 LDT 中的任务门描述符。  
- 中断或异常向量指向 IDT 中的任务门描述符。  
- 当前任务执行 **IRET** 指令时，**EFLAGS** 寄存器中的 **NT** 标志被设置。  

**JMP**、**CALL** 和 **IRET** 指令以及中断和异常都是重定向程序的通用机制。引用 TSS 描述符或任务门（当调用或跳转到任务时）或 **NT** 标志的状态（当执行 **IRET** 指令时）决定了是否发生任务切换。

处理器在切换到新任务时执行以下操作：
1. 获取新任务的 TSS 段选择子，作为 **JMP** 或 **CALL** 指令的操作数，或从任务门或前一任务链接字段（对于由 **IRET** 指令启动的任务切换）获取。
2. 检查当前（旧）任务是否被允许切换到新任务。数据访问特权规则适用于 **JMP** 和 **CALL** 指令。当前（旧）任务的 **CPL** 和新任务的段选择子的 **RPL** 必须小于或等于被引用的 TSS 描述符或任务门的 **DPL**。异常、中断（除了由 **INT n** 指令生成的中断）和 **IRET** 指令允许切换任务，而不考虑目标任务门或 TSS 描述符的 **DPL**。对于由 **INT n** 指令生成的中断，会检查 **DPL**。
3. 检查新任务的 TSS 描述符是否标记为存在并具有有效限制（大于或等于 67H）。
4. 检查新任务是否可用（调用、跳转、异常或中断）或忙（**IRET** 返回）。
5. 检查当前（旧）TSS、新 TSS 和任务切换中使用的所有段描述符是否已分页到系统内存中。
6. 如果任务切换由 **JMP** 或 **IRET** 指令启动，处理器清除当前（旧）任务的 TSS 描述符中的忙（**B**）标志；如果由 **CALL** 指令、异常或中断启动，忙（**B**）标志保持设置。（参见表 6-2。）
7. 如果任务切换由 **IRET** 指令启动，处理器清除临时保存的 **EFLAGS** 寄存器映像中的 **NT** 标志；如果由 **CALL** 或 **JMP** 指令、异常或中断启动，保存的 **EFLAGS** 映像中的 **NT** 标志保持不变。
8. 将当前（旧）任务的状态保存到当前任务的 TSS 中。处理器在任务寄存器中找到当前 TSS 的基地址，然后将以下寄存器的状态复制到当前 TSS 中：所有通用寄存器、段寄存器中的段选择子、临时保存的 **EFLAGS** 寄存器映像和指令指针寄存器（**EIP**）。
9. 如果任务切换由 **CALL** 指令、异常或中断启动，处理器将设置从新任务加载的 **EFLAGS** 中的 **NT** 标志。如果由 **IRET** 指令或 **JMP** 指令启动，**NT** 标志将反映从新任务加载的 **EFLAGS** 中的 **NT** 状态（参见表 6-2）。
10. 如果任务切换由 **CALL** 指令、**JMP** 指令、异常或中断启动，处理器设置新任务的 TSS 描述符中的忙（**B**）标志；如果由 **IRET** 指令启动，忙（**B**）标志保持设置。
11. 使用新任务的 TSS 的段选择子和描述符加载任务寄存器。
12. 将 TSS 状态加载到处理器中。这包括 **LDTR** 寄存器、**PDBR**（控制寄存器 **CR3**）、**EFLAGS** 寄存器、**EIP** 寄存器、通用寄存器和段选择子。请注意，在加载此状态期间发生的故障可能会破坏架构状态。
13. 加载与段选择子关联的描述符并进行验证。与此加载和验证相关的任何错误都在新任务的上下文中发生。

**注意：**  
此时，如果所有检查和保存都已成功执行，处理器将提交任务切换。如果在步骤 1 到 11 中发生不可恢复的错误，处理器不会完成任务切换，并确保处理器返回到执行启动任务切换的指令之前的状态。如果在步骤 12 中发生不可恢复的错误，架构状态可能会被破坏，但会尝试在之前的执行环境中处理错误。如果在提交点之后（步骤 13 中）发生不可恢复的错误，处理器将完成任务切换（不执行额外的访问和段可用性检查），并在开始执行新任务之前生成适当的异常。如果在提交点之后发生异常，异常处理程序必须自己完成任务切换，然后才能允许处理器开始执行新任务。有关在任务切换提交点之后发生的异常对任务的影响的更多信息，请参见第 5 章“中断 10——无效 TSS 异常（#TS）”。
14. 开始执行新任务。（对于异常处理程序，新任务的第一条指令似乎尚未执行。）

当成功发生任务切换时，当前执行任务的状态总是被保存。如果任务恢复，执行将从保存的 **EIP** 值指向的指令开始，并且寄存器将恢复到任务挂起时的值。

在切换任务时，新任务的特权级别不会从挂起的任务继承。新任务从 TSS 加载的 **CS** 寄存器的 **CPL** 字段指定的特权级别开始执行。由于任务通过其独立的地址空间和 TSS 隔离，并且特权规则控制对 TSS 的访问，因此软件无需在任务切换时执行显式特权检查。

表 6-1 显示了处理器在切换任务时检查的异常条件。它还显示了如果检测到错误时生成的异常以及错误代码引用的段。（表中的检查顺序是 P6 系列处理器使用的顺序。确切的顺序是模型特定的，其他 IA-32 处理器可能不同。）设计用于处理这些异常的异常处理程序如果尝试重新加载生成异常的段选择子，可能会受到递归调用的影响。应在重新加载选择子之前修复异常的原因（或多个原因中的第一个原因）。

![](/static/images/2502/p057.png)

**注意：**  
1. **#NP** 是段不存在异常，**#GP** 是一般保护异常，**#TS** 是无效 TSS 异常，**#SF** 是堆栈故障异常。  
2. 错误代码包含对引用的段描述符的索引。  
3. 如果段选择子位于兼容类型的表（GDT 或 LDT）中，占据表段限制内的地址，并引用兼容类型的描述符（例如，**CS** 寄存器中的段选择子仅在指向代码段描述符时有效），则该段选择子有效。  

控制寄存器 **CR0** 中的 **TS**（任务切换）标志在每次任务切换发生时被设置。系统软件使用 **TS** 标志来协调浮点单元在生成浮点异常时与处理器其余部分的操作。**TS** 标志表示浮点单元的上下文可能与当前任务的上下文不同。有关 **TS** 标志的功能和使用的详细说明，请参见第 2.5 节“控制寄存器”。
