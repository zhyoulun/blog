#  TASK LINKING

TSS 的前一任务链接字段（有时称为“反向链接”）和 **EFLAGS** 寄存器中的 **NT** 标志用于返回到前一任务。**NT** 标志指示当前执行的任务是否嵌套在另一个任务的执行中，如果存在，当前任务的 TSS 的前一任务链接字段保存嵌套层次结构中更高层次任务的 TSS 选择子（参见图 6-7）。

当 **CALL** 指令、中断或异常导致任务切换时，处理器将当前 TSS 的段选择子复制到新任务的 TSS 的前一任务链接字段中，然后设置 **EFLAGS** 寄存器中的 **NT** 标志。**NT** 标志指示 TSS 的前一任务链接字段已加载保存的 TSS 段选择子。如果软件使用 **IRET** 指令挂起新任务，处理器将使用前一任务链接字段中的值和 **NT** 标志返回到前一任务；即，如果 **NT** 标志被设置，处理器将执行任务切换到前一任务链接字段中指定的任务。

**注意：**  
当 **JMP** 指令导致任务切换时，新任务不会嵌套；即，**NT** 标志设置为 0，并且不使用前一任务链接字段。当不需要嵌套时，使用 **JMP** 指令调度新任务。

![](/static/images/2502/p058.png)


表6-2总结了任务切换期间忙标志（在TSS段描述符中）、NT标志、前一个任务链接字段和TS标志（在控制寄存器CR0中）的用途。请注意，NT标志可以由在任何特权级别执行的软件修改。程序可以设置其NT标志并执行IRET指令，这将导致调用当前任务的TSS中前一个链接字段指定的任务。为了防止虚假的任务切换成功，操作系统应将其创建的每个TSS的前一个任务链接字段初始化为0。


![](/static/images/2502/p059.png)


## Use of Busy Flag To Prevent Recursive Task Switching

TSS 只允许为任务保存一个上下文；因此，一旦任务被调用（调度），对任务的递归（或重入）调用将导致任务的当前状态丢失。TSS 段描述符中的忙标志用于防止重入任务切换和随后的任务状态信息丢失。处理器按以下方式管理忙标志：

1. 在调度任务时，处理器设置新任务的忙标志。
2. 如果在任务切换期间，当前任务被放置在嵌套链中（任务切换由 **CALL** 指令、中断或异常生成），当前任务的忙标志保持设置。
3. 当切换到新任务（由 **CALL** 指令、中断或异常启动）时，如果新任务的忙标志已经设置，处理器会生成一般保护异常（#GP）。（如果任务切换由 **IRET** 指令启动，则不会引发异常，因为处理器期望忙标志被设置。）
4. 当任务通过跳转到新任务（由任务代码中的 **JMP** 指令启动）或任务代码中的 **IRET** 指令终止时，处理器清除忙标志，将任务返回到“非忙”状态。

通过这种方式，处理器通过防止任务切换到自身或嵌套任务链中的任何任务来防止递归任务切换。由于多次调用、中断或异常，嵌套挂起任务的链可能会增长到任意长度。忙标志防止任务在处于此链时被调用。

忙标志可用于多处理器配置，因为处理器在设置或清除忙标志时遵循 **LOCK** 协议（在总线或缓存中）。此锁防止两个处理器同时调用同一任务。（有关在多处理器应用程序中设置忙标志的更多信息，请参见第 7.1.2.1 节“自动锁定”。）

## Modifying Task Linkages


在单处理器系统中，当需要从链接任务链中移除任务时，请使用以下步骤移除任务：

1. **禁用中断**。
2. **更改抢占任务（即暂停要移除的任务的任务）的TSS中的前一个任务链接字段**。假设抢占任务是要移除的任务链中的下一个任务（较新的任务）。将前一个任务链接字段更改为指向链中下一个较旧任务的TSS，或链中更旧的任务。
3. **清除要从链中移除的任务的TSS段描述符中的忙（B）标志**。如果要从链中移除多个任务，则必须清除每个要移除任务的忙标志。
4. **启用中断**。

在多处理器系统中，必须在此过程中添加额外的同步和序列化操作，以确保在更改前一个任务链接字段和清除忙标志时，TSS及其段描述符都被锁定。