高级可编程中断控制器（APIC），在以下部分中称为本地APIC，是在Pentium处理器中引入IA-32处理器的（参见第18.23节“高级可编程中断控制器（APIC）”），并包含在Pentium 4、Intel Xeon和P6系列处理器中（参见第8.4.2节“本地APIC的存在”）。本地APIC为处理器执行两个主要功能：

- **接收来自处理器中断引脚、内部源和/或外部I/O APIC（或其他外部中断控制器）的中断，并将它们发送到处理器核心进行处理**。
- **在多处理器（MP）系统中，它发送和接收来自系统总线上其他IA-32处理器的处理器间中断（IPI）消息**。这些IPI消息可用于在系统中的处理器之间分配中断，或执行系统范围内的功能（例如，启动处理器或在一组处理器之间分配工作）。

外部I/O APIC是Intel系统芯片组的一部分。其主要功能是接收来自系统及其相关I/O设备的外部中断事件，并将它们作为中断消息转发到本地APIC。在MP系统中，I/O APIC还提供了一种机制，用于将外部中断分配给系统总线上选定的处理器或处理器组的本地APIC。

本章提供了本地APIC及其编程接口的详细描述。它还提供了本地APIC与I/O APIC之间接口的概述。有关I/O APIC的详细信息，请联系Intel。

当本地APIC将中断发送到其关联的处理器核心进行处理时，处理器使用第5章“中断和异常处理”中描述的中断和异常处理机制来服务中断。第5.1节“中断和异常概述”介绍了IA-32架构中的中断和异常处理。建议在阅读以下部分之前先阅读本节，以帮助理解IA-32 APIC架构及其功能。


# 8.1. LOCAL AND I/O APIC OVERVIEW

每个本地 APIC 由一组 APIC 寄存器（参见表 8-1）和相关硬件组成，这些硬件控制中断传递到处理器核心以及 IPI 消息的生成。APIC 寄存器是内存映射的，可以使用 **MOV** 指令读取和写入。

本地 APIC 可以从以下来源接收中断：
- **本地连接的 I/O 设备**。这些中断源自直接连接到处理器的本地中断引脚（**LINT0** 和 **LINT1**）的 I/O 设备触发的边沿或电平。I/O 设备也可以连接到 8259 型中断控制器，该控制器又通过其中一个本地中断引脚连接到处理器。  
- **外部连接的 I/O 设备**。这些中断源自连接到 I/O APIC 的中断输入引脚的 I/O 设备触发的边沿或电平。这些中断作为 I/O 中断消息从 I/O APIC 发送到系统中一个或多个 IA-32 处理器。  
- **处理器间中断（IPI）**。IA-32 处理器可以使用 IPI 机制中断系统总线上的另一个处理器或处理器组。IPI 用于诸如软件自中断、中断转发或抢占式调度等操作。  
- **APIC 定时器生成的中断**。可以编程本地 APIC 定时器，在达到编程计数时向其关联的处理器发送本地中断（参见第 8.5.4 节“APIC 定时器”）。  
- **性能监控计数器中断**。Pentium 4、Intel Xeon 和 P6 系列处理器提供了在性能监控计数器溢出时向其关联的处理器发送中断的能力（参见第 15.9.6.9 节“溢出时生成中断”）。  
- **热传感器中断**。Pentium 4 和 Intel Xeon 处理器提供了在内部热传感器触发时向自身发送中断的能力（参见第 13.15.2 节“热监控器”）。  
- **APIC 内部错误中断**。当在本地 APIC 中识别到错误条件（例如尝试访问未实现的寄存器）时，可以编程 APIC 向其关联的处理器发送中断（参见第 8.5.3 节“错误处理”）。  

在这些中断源中，处理器的 **LINT0** 和 **LINT1** 引脚、APIC 定时器、性能监控计数器、热传感器和内部 APIC 错误检测器被称为**本地中断源**。在接收到来自本地中断源的信号后，本地 APIC 使用通过一组称为本地向量表（LVT）的 APIC 寄存器设置的中断传递协议将中断传递到处理器核心（参见第 8.5.1 节“本地向量表”）。本地向量表中为每个本地中断源提供了一个单独的条目，允许为每个源设置特定的中断传递协议。例如，如果 **LINT1** 引脚将用作 NMI 引脚，则可以在本地向量表中设置 **LINT1** 条目，以将向量号为 2（NMI 中断）的中断传递到处理器核心。

本地 APIC 通过其 IPI 消息处理设施处理来自其他两个中断源（外部连接的 I/O 设备和 IPI）的中断。

处理器可以通过编程其本地 APIC 中的中断命令寄存器（ICR）生成 IPI（参见第 8.6.1 节“中断命令寄存器（ICR）”）。写入 ICR 的操作会导致生成 IPI 消息并在系统总线（对于 Pentium 4 和 Intel Xeon 处理器）或 APIC 总线（对于 Pentium 和 P6 系列处理器）上发出。

（参见第 8.2 节“系统总线与 APIC 总线”。）IPI 可以发送到系统中的其他 IA-32 处理器或发送到发起处理器（自中断）。当目标处理器接收到 IPI 消息时，其本地 APIC 会自动处理该消息（使用消息中包含的信息，如向量号和触发模式）并将其传递到处理器核心进行处理。有关本地 APIC 的 IPI 消息传递和接受机制的详细说明，请参见第 8.6 节“发出处理器间中断”。

本地 APIC 还可以通过 I/O APIC 接收来自外部设备的中断（参见图 8-1）。I/O APIC 负责接收系统硬件和 I/O 设备生成的中断，并将它们作为中断消息转发到本地 APIC。

![](/static/images/2502/p063.png)


I/O APIC上的各个引脚可以编程为在置位时生成特定的中断向量。I/O APIC还具有“虚拟线模式”，允许其与标准的8259A风格的外部中断控制器通信。

请注意，本地APIC可以被禁用（参见第8.4.3节“启用或禁用本地APIC”），从而允许其关联的处理器核心直接从8259A中断控制器接收中断。

本地APIC和I/O APIC都设计用于在MP系统中操作（参见图8-2和图8-3）。在这里，每个本地APIC处理从I/O APIC接收的外部生成的中断消息和来自系统总线上其他处理器的IPI，以及来自它自身的中断。（中断也可以通过本地中断引脚传递给各个处理器；然而，这种机制在MP系统中通常不使用。）


![](/static/images/2502/p064.png)

![](/static/images/2502/p065.png)

IPI 机制通常用于 MP 系统中，以向系统总线上的其他处理器或自身发送固定中断（特定向量号的中断）和特殊用途中断。例如，一个本地 APIC 可以使用 IPI 将固定中断转发到另一个处理器进行处理。特殊用途的 IPI，包括 **NMI**、**INIT**、**SMI** 和 **SIPI IPI**，允许系统总线上的一个或多个处理器执行系统范围的启动和控制功能。

以下部分重点介绍本地 APIC 及其在 Pentium 4、Intel Xeon 和 P6 系列处理器中的实现。在这些部分的描述中，通用术语“本地 APIC”和“I/O APIC”指的是与 P6 系列处理器一起使用的本地和 I/O APIC，以及与 Pentium 4 和 Intel Xeon 处理器一起使用的本地和 I/O xAPIC（参见第 8.3 节“Intel 82489DX 外部 APIC、APIC 和 xAPIC 之间的关系”）。