# 8.4. LOCAL APIC

以下部分描述了本地APIC的架构以及如何检测、识别和确定其状态。有关如何编程本地APIC的描述，请参见第8.5.1节“本地向量表”和第8.6.1节“中断命令寄存器（ICR）”。

## 8.4.1. The Local APIC Block Diagram

图 8-4 提供了本地 APIC 的功能框图。软件通过读取和写入其寄存器与本地 APIC 交互。APIC 寄存器被内存映射到处理器物理地址空间的 4 KB 区域，初始起始地址为 **FEE00000H**。为了正确运行 APIC，此地址空间必须映射到被指定为强不可缓存（UC）的内存区域。参见第 10.3 节“可用的缓存方法”。

在 MP 系统配置中，系统总线上所有 IA-32 处理器的 APIC 寄存器最初映射到物理地址空间的同一 4 KB 区域。软件可以选择将所有本地 APIC 的初始映射更改为不同的 4 KB 区域，或者将每个本地 APIC 的 APIC 寄存器映射到其自己的 4 KB 区域。第 8.4.5 节“重定位本地 APIC 寄存器”描述了如何重定位特定处理器的 APIC 寄存器的基地址。

**注意：**  
对于 Pentium 4、Intel Xeon 和 P6 系列处理器，APIC 在内部处理对 4 KB APIC 寄存器空间地址的所有内存访问，并且不会产生外部总线周期。对于具有片上 APIC 的 Pentium 处理器，访问 APIC 寄存器空间会产生总线周期。因此，对于旨在在 Pentium 处理器上运行的软件，系统软件应明确不将 APIC 寄存器空间映射到常规系统内存。这样做可能会导致生成无效操作码异常（#UD）或不可预测的执行。

![](/static/images/2502/p066.png)

表8-1显示了APIC寄存器如何映射到4KB的APIC寄存器空间中。所有寄存器的宽度为32位、64位或256位，并且都对齐在128位边界上。所有32位寄存器必须使用128位对齐的32位加载或存储来访问。较宽的寄存器（64位或256位）必须使用多个32位加载或存储来访问，首次访问必须是128位对齐的。如果LOCK前缀与访问APIC地址空间的MOV指令一起使用，该前缀将被忽略；也就是说，不会发生锁定操作。表8-1中列出的所有寄存器将在本章的后续部分中描述。

![](/static/images/2502/p067.png)

![](/static/images/2502/p068.png)

**注意：**  
1. **Pentium 4 和 Intel Xeon 处理器不支持**。  
2. **在 Pentium 4 和 Intel Xeon 处理器中引入**。此 APIC 寄存器及其相关功能是依赖于实现的，可能不会出现在未来的 IA-32 处理器中。  
3. **在 Pentium Pro 处理器中引入**。此 APIC 寄存器及其相关功能是依赖于实现的，可能不会出现在未来的 IA-32 处理器中。  

**注意：**  
表 8-1 中列出的本地 APIC 寄存器不是 MSR。与本地 APIC 编程相关的唯一 MSR 是 **IA32_APIC_BASE MSR**（参见第 8.4.3 节“启用或禁用本地 APIC”）。

## 8.4.2. Presence of the Local APIC

从P6系列处理器开始，可以使用CPUID指令检测芯片上是否存在本地APIC。当CPUID指令执行时，EAX寄存器中的源操作数为1，返回的EDX寄存器中的CPUID功能标志的第9位指示本地APIC的存在（置位）或不存在（清除）。

## 8.4.3. Enabling or Disabling the Local APIC

本地 APIC 可以通过以下两种方式之一启用或禁用：
- **IA32_APIC_BASE MSR 中的 APIC 全局启用/禁用标志**（参见图 8-5）。  
- **伪中断向量寄存器中的 APIC 软件启用/禁用标志**（参见图 8-22）。  

**IA32_APIC_BASE MSR** 中的 APIC 全局启用/禁用标志允许永久禁用本地 APIC。在电源启动或复位后，此标志被设置，启用本地 APIC。要永久禁用本地 APIC 直到下次电源启动或复位，软件可以清除此标志。当此标志被清除时，处理器在功能上等同于没有片上 APIC 的 IA-32 处理器（例如，Intel486 处理器）。在此状态下，CPUID 功能标志中的 APIC 标志（**EDX** 寄存器的位 9 [参见第 8.4.2 节“本地 APIC 的存在”]）被设置为 0。此外，当 **IA32_APIC_BASE MSR** 标志中的 APIC 全局启用/禁用标志被清除时，只能通过电源启动或复位操作重新设置。

![](/static/images/2502/p069.png)

对于Pentium处理器，APICEN引脚（与PICD1引脚共享）在上电或复位期间用于禁用本地APIC。

如果IA32_APIC_BASE MSR中的APIC全局启用/禁用标志未被清除，软件可以通过清除伪中断向量寄存器中的APIC软件启用/禁用标志（参见图8-22）随时临时禁用本地APIC。本地APIC在此软件禁用状态下的状态在第8.4.7.2节“本地APIC在软件禁用后的状态”中描述。当本地APIC处于软件禁用状态时，可以通过将APIC软件启用/禁用标志设置为1随时重新启用它。

请注意，LVT中的每个条目都有一个掩码位，可用于阻止从选定的本地中断源（LINT0和LINT1引脚、APIC定时器、性能监控计数器、热传感器和/或内部APIC错误检测器）向处理器传递中断。

## 8.4.4. Local APIC Status and Location

本地 APIC 的状态和位置包含在 **IA32_APIC_BASE MSR**（在 P6 系列处理器中称为 **APIC_BASE_MSR**）中。此 MSR 位于 MSR 地址 27（1BH）。图 8-5 显示了此 MSR 中位的编码。这些位的功能如下：
- **BSP 标志，位 8**：指示处理器是否为引导处理器（BSP）（参见第 7.5 节“多处理器（MP）初始化”）。在电源启动或复位后，此标志对于被选为 BSP 的处理器设置为 1，对于其余应用程序处理器（AP）设置为 0。  
- **APIC 全局启用标志，位 11**：启用（1）或禁用（0）本地 APIC（参见第 8.4.3 节“启用或禁用本地 APIC”）。此标志在 Pentium 4、Intel Xeon 和 P6 系列处理器中可用。不能保证它在未来的 IA-32 处理器中可用或位于相同位置。  
- **APIC 基址字段，位 12 到 35**：指定 APIC 寄存器的基地址。此 24 位值在低端扩展 12 位以形成基地址，该地址自动对齐到 4 KB 边界。在电源启动或复位后，此字段设置为 **FEE00000H**。  

**IA32_APIC_BASE MSR** 中的位 0 到 7、位 9 和 10 以及位 36 到 63 保留。

## 8.4.5. Relocating the Local APIC Registers

Pentium 4、Intel Xeon和P6系列处理器允许通过修改IA32_APIC_BASE MSR中的24位基地址字段的值，将APIC寄存器的起始地址从FEE00000H重新定位到另一个物理地址。APIC架构的此扩展旨在帮助解决与现有系统内存映射的冲突，并允许MP系统中的各个处理器将其APIC寄存器映射到物理内存中的不同位置。

## 8.4.6. Local APIC ID

在电源启动时，系统硬件为系统总线（对于 Pentium 4 和 Intel Xeon 处理器）或 APIC 总线（对于 P6 系列和 Pentium 处理器）上的每个本地 APIC 分配一个唯一的 APIC ID。硬件分配的 APIC ID 基于系统拓扑，并包括插槽位置和集群信息的编码（参见图 7-2）。

在 MP 系统中，本地 APIC ID 也被 BIOS 和操作系统用作处理器 ID。

处理器通过采样引脚 **A11#** 和 **A12#** 以及引脚 **BR0#** 到 **BR3#**（对于 Pentium 4、Intel Xeon 和 P6 系列处理器）和引脚 **BE0#** 到 **BE3#**（对于 Pentium 处理器）接收硬件分配的 APIC ID。从这些引脚锁存的 APIC ID 存储在本地 APIC ID 寄存器的 APIC ID 字段中（参见图 8-6），并用作处理器的初始 APIC ID。当在 **EAX** 寄存器中使用源操作数值 1 执行 **CPUID** 指令时，它也是返回到 **EBX** 寄存器的值。

![](/static/images/2502/p070.png)

对于P6系列和Pentium处理器，本地APIC ID寄存器中的本地APIC ID字段为4位，编码0H到EH可用于唯一标识连接到APIC总线的15个不同处理器。对于Pentium 4和Intel Xeon处理器，xAPIC规范将本地APIC ID字段扩展到8位，可用于标识系统中最多255个处理器。

在上电或硬件复位后，软件（通常是BIOS软件）可以修改系统中每个处理器的本地APIC ID寄存器中的APIC ID字段。在更改APIC ID时，软件必须确保每个本地APIC的APIC ID在整个系统中是唯一的。

## 8.4.7. Local APIC State

以下部分描述了本地 APIC 及其寄存器在电源启动或复位后、软件禁用后、**INIT** 复位后以及接收到 **INIT** 解除消息后的状态。

#### 8.4.7.1. 电源启动或复位后的本地 APIC 状态  
在处理器电源启动或复位后，本地 APIC 及其寄存器的状态如下：
- 以下寄存器被重置为全 0：**IRR**、**ISR**、**TMR**、**ICR**、**LDR** 和 **TPR** 寄存器；定时器初始计数和定时器当前计数寄存器；以及分频配置寄存器。  
- **DFR** 寄存器被重置为全 1。  
- **LVT** 寄存器条目被重置为全 0，除了掩码位被设置为 1。  
- 本地 APIC 版本寄存器不受影响。  
- 本地 APIC ID 寄存器被设置为唯一的 APIC ID。（仅限 Pentium 和 P6 系列处理器）**Arb ID** 寄存器被设置为 APIC ID 寄存器中的值。  
- 伪中断向量寄存器初始化为 **0000 00FFH**。位 8 设置为 0 会软件禁用本地 APIC。  
- 如果处理器是系统中的唯一处理器，或者它在 MP 系统中被指定为 BSP（参见第 7.5.1 节“BSP 和 AP 处理器”），本地 APIC 将正常响应 **INIT** 和 **NMI** 消息，以及 **INIT#** 和 **STPCLK#** 信号；如果它在 MP 系统中被指定为 AP，本地 APIC 将像 BSP 一样响应，并且还会响应 **SIPI** 消息。（仅限 P6 系列处理器）AP 不会响应 **STPCLK#** 信号。  

#### 8.4.7.2. 软件禁用后的本地 APIC 状态  
当伪中断向量寄存器中的 APIC 软件启用/禁用标志被显式清除（与在电源启动或复位期间清除不同）时，本地 APIC 被暂时禁用（参见第 8.4.3 节“启用或禁用本地 APIC”）。在软件禁用状态下，本地 APIC 的操作和响应如下：
- 本地 APIC 将正常响应 **INIT**、**NMI**、**SMI** 和 **SIPI** 消息。  
- **IRR** 和 **ISR** 寄存器中的挂起中断被保留，需要由 CPU 进行屏蔽或处理。  
- 本地 APIC 仍然可以发出 IPI。如果不需要通过此机制发送中断，软件应避免通过 IPI 机制和 **ICR** 寄存器发出 IPI。  
- 在本地 APIC 禁用时，正在进行的任何 IPI 的接收或传输在本地 APIC 进入软件禁用状态之前完成。  
- 所有 **LVT** 条目的掩码位被设置。尝试重置这些位将被忽略。  
- （仅限 Pentium 和 P6 系列处理器）本地 APIC 继续监听所有总线消息，以保持其仲裁 ID 与系统其余部分同步。  

#### 8.4.7.3. INIT 复位后的本地 APIC 状态（“等待 SIPI”状态）  
处理器的 **INIT** 复位可以通过以下两种方式之一启动：
- 通过置位处理器的 **INIT#** 引脚。  
- 通过向处理器发送 **INIT IPI**（向其发送传递模式设置为 **INIT** 的 IPI）。  

通过这两种机制中的任何一种接收到 **INIT** 后，处理器通过开始处理器核心和本地 APIC 的初始化过程来响应。**INIT** 复位后本地 APIC 的状态与电源启动或硬件复位后的状态相同，除了 APIC ID 和仲裁 ID 寄存器不受影响。此状态也称为“等待 SIPI”状态。有关 MP 系统中电源启动或复位后 **INIT** 的影响的讨论，请参见第 7.5.2 节“Intel Xeon 处理器的 MP 初始化协议要求和限制”。

#### 8.4.7.4. 接收到 INIT 解除 IPI 后的本地 APIC 状态  
（仅限 Pentium 和 P6 系列处理器支持 **INIT** 解除 IPI。）**INIT** 解除 IPI 对 APIC 的状态没有影响，除了将仲裁 ID 寄存器重新加载为 APIC ID 寄存器中的值。

## 8.4.8. Local APIC Version Register


本地APIC包含一个硬连线的版本寄存器，软件可以使用它来识别APIC版本（参见图8-7）。此外，该寄存器还指定了特定实现中本地向量表（LVT）的条目数。本地APIC版本寄存器中的字段如下：

**版本** 本地APIC的版本号：
- **1XH** 本地APIC。对于Pentium 4和Intel Xeon处理器，返回14H。
- **0XH** 82489DX外部APIC。
- **20H到FFH** 保留。

**最大LVT条目** 显示LVT条目数减1。对于Pentium 4和Intel Xeon处理器（有6个LVT条目），Max LVT字段返回的值为5；对于P6系列处理器（有5个LVT条目），返回的值为4；对于Pentium处理器（有4个LVT条目），返回的值为3。

![](/static/images/2502/p071.png)

