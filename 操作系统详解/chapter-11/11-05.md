# 8.5. 处理本地中断

以下部分描述了本地 APIC 中提供的用于处理本地中断的设施，包括处理器的 **LINT0** 和 **LINT1** 引脚、APIC 定时器、性能监控计数器、热传感器和内部 APIC 错误检测器。本地中断处理设施包括 **LVT**、错误状态寄存器（**ESR**）、分频配置寄存器（**DCR**）以及初始计数和当前计数寄存器。

## 8.5.1. Local Vector Table

本地向量表（LVT）允许软件指定本地中断如何传递到处理器核心。它由以下五个32位APIC寄存器组成（参见图8-8），每个本地中断对应一个寄存器：

- **LVT定时器寄存器（FEE0 0320H）** — 指定APIC定时器发出中断时的中断传递方式（参见第8.5.4节“APIC定时器”）。
- **LVT热监控寄存器（FEE0 0330H）** — 指定热传感器生成中断时的中断传递方式（参见第13.15.2节“热监控”）。此LVT条目是特定于实现的，不是架构的一部分。如果实现，它将始终位于基地址FEE0 0330H。
- **LVT性能计数器寄存器（FEE0 0340H）** — 指定性能计数器在溢出时生成中断时的中断传递方式（参见第15.9.6.9节“溢出时生成中断”）。此LVT条目是特定于实现的，不是架构的一部分。如果实现，不保证其位于基地址FEE0 0340H。
- **LVT LINT0寄存器（FEE0 0350H）** — 指定在LINT0引脚发出中断时的中断传递方式。
- **LVT LINT1寄存器（FEE0 0360H）** — 指定在LINT1引脚发出中断时的中断传递方式。
- **LVT错误寄存器（FEE0 0370H）** — 指定APIC检测到内部错误时的中断传递方式（参见第8.5.3节“错误处理”）。

**注意**  
LVT性能计数器寄存器及其相关中断是在P6处理器中引入的，也存在于Pentium 4和Intel Xeon处理器中。LVT热监控寄存器及其相关中断是在Pentium 4和Intel Xeon处理器中引入的。

请注意，如图8-8所示，某些字段和标志在某些条目中不可用（且保留）。

![](/static/images/2502/p072.png)

可以在 LVT 表寄存器中指定的设置信息如下：

- **向量**：中断向量号。  
- **传递模式**：指定要发送到处理器的中断类型。请注意，某些传递模式仅在结合特定触发模式使用时才能按预期运行。允许的传递模式如下：  
  - **000（固定）**：传递向量字段中指定的中断。  
  - **010（SMI）**：通过处理器的本地 SMI 信号路径向处理器核心传递 SMI 中断。使用此传递模式时，向量字段应设置为 **00H** 以确保未来兼容性。  
  - **100（NMI）**：向处理器传递 NMI 中断。向量信息被忽略。  
  - **101（INIT）**：向处理器核心传递 INIT 请求，导致处理器执行 INIT。使用此传递模式时，向量字段应设置为 **00H** 以确保未来兼容性。  
  - **111（ExtINT）**：使处理器响应中断，就像中断源自外部连接的（8259A 兼容）中断控制器一样。与 ExtINT 对应的特殊 INTA 总线周期被路由到外部控制器。外部控制器应提供向量信息。APIC 架构在系统中仅支持一个 ExtINT 源，通常包含在兼容桥中。  

- **传递状态（只读）**：指示中断传递状态，如下：  
  - **0（空闲）**：当前此中断源没有活动，或此前从此源传递的中断已被处理器核心接受。  
  - **1（发送挂起）**：表示从此源传递的中断已传递到处理器核心，但尚未被接受（参见第 8.5.5 节“本地中断接受”）。  

- **中断输入引脚极性**：指定相应中断引脚的极性：(0) 高电平有效或 (1) 低电平有效。  

- **远程 IRR 标志（只读）**：对于固定模式、电平触发的中断，当本地 APIC 接受中断进行处理时，此标志被设置，并在从处理器接收到 EOI 命令时被重置。对于边沿触发中断和其他传递模式，此标志的含义未定义。  

- **触发模式**：选择本地 **LINT0** 和 **LINT1** 引脚的触发模式：(0) 边沿敏感和 (1) 电平敏感。此标志仅在传递模式为固定时使用。当传递模式为 NMI、SMI 或 INIT 时，触发模式始终为边沿敏感；当传递模式为 ExtINT 时，触发模式始终为电平敏感。定时器和错误中断始终被视为边沿敏感。  
  如果本地 APIC 不与 I/O APIC 结合使用并且选择了固定传递模式，Pentium 4、Intel Xeon 和 P6 系列处理器将始终使用电平敏感触发，无论是否选择了边沿敏感触发。  

- **中断掩码**：中断掩码：(0) 启用中断接收，(1) 禁止中断接收。当本地 APIC 处理性能监控计数器中断时，它会自动设置相应 LVT 条目中的掩码标志。此标志将保持设置，直到软件清除它。  

- **定时器模式**：选择定时器模式：(0) 单次触发和 (1) 周期性触发（参见第 8.5.4 节“APIC 定时器”）。

## 8.5.2. Valid Interrupt Vectors

IA-32架构定义了256个向量号，范围从0到255（参见第5.2节“异常和中断向量”）。本地和I/O APIC支持其中240个向量（范围16到255）作为有效中断。

当通过本地APIC发送或接收0到15范围内的中断向量时，APIC会在其错误状态寄存器中指示非法向量（参见第8.5.3节“错误处理”）。IA-32架构保留向量16到31用于预定义的中断、异常和Intel保留的编码（参见表5-1）；然而，本地APIC不会将此范围内的向量视为非法。

当将非法向量值（0到15）写入LVT条目且传递模式为Fixed（第8-11位等于0）时，APIC可能会发出非法向量错误信号，而不考虑掩码位是否设置或是否在输入上实际看到中断。

## 8.5.3. Error Handling

本地 APIC 提供了一个错误状态寄存器（**ESR**），用于记录在处理中断时检测到的错误（参见图 8-9）。当本地 APIC 设置 **ESR** 中的某个错误位时，会生成 APIC 错误中断。**LVT 错误寄存器**允许选择在检测到 APIC 错误时传递到处理器核心的中断向量。**LVT 错误寄存器**还提供了一种屏蔽 APIC 错误中断的方法。

**ESR** 标志的功能如下：
- **发送校验和错误**（仅限 P6 系列和 Pentium 处理器）：当本地 APIC 检测到其在 APIC 总线上发送的消息的校验和错误时设置。  
- **接收校验和错误**（仅限 P6 系列和 Pentium 处理器）：当本地 APIC 检测到其在 APIC 总线上接收的消息的校验和错误时设置。  
- **发送接受错误**（仅限 P6 系列和 Pentium 处理器）：当本地 APIC 检测到其发送的消息未被 APIC 总线上的任何 APIC 接受时设置。  
- **接收接受错误**（仅限 P6 系列和 Pentium 处理器）：当本地 APIC 检测到其接收的消息未被 APIC 总线上的任何 APIC（包括其自身）接受时设置。  
- **发送非法向量**：当本地 APIC 检测到其发送的消息中的非法向量时设置。  
- **接收非法向量**：当本地 APIC 检测到其接收的消息中的非法向量时设置，包括本地向量表中断或自中断中的非法向量代码。  
- **非法寄存器地址**（仅限 Pentium 4、Intel Xeon 和 P6 系列处理器）：当处理器尝试访问未在处理器本地 APIC 寄存器地址空间中实现的寄存器时设置；即在 APIC 寄存器基地址（在 **IA32_APIC_BASE MSR** 中指定）加 4 KB 的地址范围内。

![](/static/images/2502/p073.png)

ESR是一个写/读寄存器。在读取ESR以更新寄存器之前，必须对ESR进行写操作（写入任何值）。此初始写操作会导致ESR内容更新为最新的错误状态。连续写入会清除ESR寄存器。

在寄存器中设置错误位后，该位将保持设置状态，直到寄存器被清除。设置LVT错误寄存器的掩码位会阻止错误记录到ESR中；然而，掩码位设置之前的ESR状态将保持不变。

## 8.5.4. APIC Timer

本地 APIC 单元包含一个 32 位可编程定时器，可供软件用于计时事件或操作。此定时器通过编程四个寄存器来设置：divide configuration
register（分频配置寄存器）（参见图 8-10）、initial-count（初始计数）和current-count registers（当前计数寄存器）（参见图 8-11）以及 LVT timer register（LVT 定时器寄存器）（参见图 8-8）。

![](/static/images/2502/p074.png)

![](/static/images/2502/p075.png)

定时器的时间基准来源于处理器的总线时钟，并除以**divide configuration register（DCR，分频配置寄存器）**中指定的值。

定时器可以通过 **LVT（本地向量表）定时器条目** 配置为单次触发模式或周期性模式：
- **单次触发模式**：
  - 通过编程其初始计数寄存器启动定时器。
  - 初始计数值被复制到当前计数寄存器中，并开始倒计时。
  - 当定时器计数达到 0 时，生成定时器中断，定时器保持为 0 值，直到重新编程。
- **周期性模式**：
  - 当计数达到 0 时，当前计数寄存器会自动从初始计数寄存器重新加载，并生成定时器中断，倒计时重复进行。
  - 如果在倒计时过程中设置了初始计数寄存器，计数将使用新的初始计数值重新开始。

**初始计数寄存器** 是一个可读写的寄存器；**当前计数寄存器** 是只读的。

**LVT 定时器寄存器** 决定了当定时器计数达到 0 时生成的定时器中断所传递的向量号。LVT 定时器寄存器中的**屏蔽标志** 可用于屏蔽定时器中断。

## 8.5.5. Local Interrupt Acceptance

当本地中断发送到处理器核心时，它受图 8-17 中中断接受流程图中指定的接受标准约束。如果中断被接受，它将被记录到 **IRR** 寄存器中，并根据其优先级由处理器处理（参见第 8.8.4 节“固定中断的接受”）。如果中断未被接受，它将被发送回本地 APIC 并重试。