# 8.6. ISSUING INTERPROCESSOR INTERRUPTS


以下部分描述了本地 APIC 提供的用于从软件发出处理器间中断（IPI）的设施。用于发出 IPI 的主要本地 APIC 设施是**中断命令寄存器（ICR）**。**ICR** 可用于以下功能：
- 向另一个处理器发送中断。  
- 允许处理器将其接收但未处理的中断转发到另一个处理器进行处理。  
- 指示处理器中断自身（执行自中断）。  
- 向其他处理器或自身传递特殊 IPI，例如启动 IPI（**SIPI**）消息。  

通过此设施生成的中断通过系统总线（对于 Pentium 4 和 Intel Xeon 处理器）或 APIC 总线（对于 P6 系列和 Pentium 处理器）传递到系统中的其他处理器。

### 8.6.1. 中断命令寄存器（ICR）  
**中断命令寄存器（ICR）** 是一个 64 位的本地 APIC 寄存器（参见图 8-12），允许在处理器上运行的软件指定并向系统中的其他 IA-32 处理器发送处理器间中断（IPI）。

要发送 IPI，软件必须设置 **ICR** 以指示要发送的 IPI 消息类型以及目标处理器或处理器组。（**ICR** 的所有字段均可由软件读写，除了传递状态字段是只读的。）写入 **ICR** 的低双字的操作会导致 IPI 被发送。

**ICR** 由以下字段组成：
- **向量**：正在发送的中断的向量号。

![](/static/images/2502/p076.png)

**传递模式**：指定要发送的 IPI 类型。此字段也称为 IPI 消息类型字段。  
- **000（固定）**：将向量字段中指定的中断传递给目标处理器或处理器组。  
- **001（最低优先级）**：与固定模式相同，只是中断被传递给目标字段中指定的处理器组中执行优先级最低的处理器。（对于 Pentium 4 和 Intel Xeon 处理器，不建议使用此传递模式，因为它可能会导致发送多个 IPI，从而降低性能。）  
- **010（SMI）**：向目标处理器或处理器组传递 SMI 中断。向量字段必须编程为 **00H** 以确保未来兼容性。  
- **011（保留）**  
- **100（NMI）**：向目标处理器或处理器组传递 NMI 中断。向量信息被忽略。  
- **101（INIT）**：向目标处理器或处理器组传递 INIT 请求，导致它们执行 INIT。作为此 IPI 消息的结果，所有目标处理器都执行 INIT。向量字段必须编程为 **00H** 以确保未来兼容性。  
- **101（INIT 电平解除）**（Pentium 4 和 Intel Xeon 处理器不支持）：向系统中的所有本地 APIC 发送同步消息，以将其仲裁 ID（存储在其 **Arb ID** 寄存器中）设置为其 APIC ID 的值（参见第 8.7 节“系统和 APIC 总线仲裁”）。对于此传递模式，电平标志必须设置为 0，触发模式标志设置为 1。此 IPI 发送给所有处理器，无论目标字段或目标简写字段中的值如何；然而，软件应指定“包括自身在内的所有”简写。  
- **110（启动）**：向目标处理器或处理器组发送特殊的“启动”IPI（称为 **SIPI**）。向量通常指向作为 BIOS 引导代码一部分的启动例程（参见第 7.5 节“多处理器（MP）初始化”）。请注意，如果源 APIC 无法传递此 IPI，则不会自动重试。软件需要确定 **SIPI** 是否未成功传递，并在必要时重新发出 **SIPI**。  

**目标模式**：选择物理（0）或逻辑（1）目标模式（参见第 8.6.2 节“确定 IPI 目标”）。  

**传递状态（只读）**：指示 IPI 传递状态，如下：  
- **0（空闲）**：当前此本地 APIC 没有 IPI 活动，或此前从此本地 APIC 发送的 IPI 已被目标处理器或处理器组传递和接受。  
- **1（发送挂起）**：表示此前从此本地 APIC 发送的 IPI 尚未被目标处理器或处理器组接受。  

**电平**：对于 **INIT** 电平解除传递模式，此标志必须设置为 0；对于所有其他传递模式，必须设置为 1。（此标志在 Pentium 4 和 Intel Xeon 处理器中没有意义，并且始终作为 1 发出。）  

**触发模式**：选择使用 **INIT** 电平解除传递模式时的触发模式：边沿（0）或电平（1）。对于所有其他传递模式，它被忽略。（此标志在 Pentium 4 和 Intel Xeon 处理器中没有意义，并且始终作为 0 发出。）  

**目标简写**：指示是否使用简写符号来指定中断的目标，如果是，则使用哪种简写。目标简写用于代替 8 位目标字段，并且可以通过对 **ICR** 的低双字进行单次写入由软件发送。简写定义以下情况：软件自中断、发送给系统中包括发送者在内的所有处理器的 IPI、发送给系统中不包括发送者的所有处理器的 IPI。  
- **00（无简写）**：目标在目标字段中指定。  
- **01（自身）**：发出 APIC 是 IPI 的唯一目标。此目标简写允许软件中断其正在执行的处理器。APIC 实现可以自由地在内部传递自中断消息，或像任何其他 IPI 消息一样将消息发布到总线并“窥探”它。  
- **10（包括自身在内的所有）**：IPI 发送给系统中包括发送者在内的所有处理器。APIC 将广播一个 IPI 消息，目标字段设置为 **FH**（对于 Pentium 和 P6 系列处理器）或 **FFH**（对于 Pentium 4 和 Intel Xeon 处理器）。  
- **11（不包括自身在内的所有）**：IPI 发送给系统中不包括发送者在内的所有处理器。APIC 将使用物理目标模式和目标字段设置为 **FH**（对于 Pentium 和 P6 系列处理器）或 **FFH**（对于 Pentium 4 和 Intel Xeon 处理器）广播消息。（对于 Pentium 4 和 Intel Xeon 处理器，当此目标简写与最低优先级传递模式结合使用时，IPI 可能会被重定向回发出处理器。）  

**目标**：指定目标处理器或处理器组。此字段仅在目标简写字段设置为 **00B** 时使用。如果目标模式设置为物理，则位 56 到 59 包含目标处理器的 APIC ID（对于 Pentium 和 P6 系列处理器），位 56 到 63 包含目标处理器的 APIC ID（对于 Pentium 4 和 Intel Xeon 处理器）。如果目标模式设置为逻辑，8 位目标字段的解释取决于系统中所有处理器的本地 APIC 的 **DFR** 和 **LDR** 寄存器的设置（参见第 8.6.2 节“确定 IPI 目标”）。  

请注意，并非 **ICR** 的所有选项组合都有效。表 8-2 显示了 Pentium 4 和 Intel Xeon 处理器的 **ICR** 字段的有效组合；表 8-3 显示了 P6 系列处理器的 **ICR** 字段的有效组合。



![](/static/images/2502/p077.png)


![](/static/images/2502/p078.png)

**注意：**  
1. 对于这些中断，如果触发模式位为 1（电平），本地 xAPIC 将覆盖位设置并作为边沿触发中断发出。  
2. **X**——无关紧要。  
3. 当使用“最低优先级”传递模式和“不包括自身在内的所有”目标时，IPI 可能会被重定向回发出 APIC，这本质上与“包括自身在内的所有”目标模式相同。


![](/static/images/2502/p079.png)

## 8.6.2. 确定 IPI 目标
IPI 的目标可以是系统总线上的一个、全部或一部分（组）处理器。IPI 的发送者通过以下 APIC 寄存器和寄存器中的字段来指定 IPI 的目标：
• ICR 寄存器——ICR 寄存器中的以下字段用于指定 IPI 的目标：
— 目标模式——选择两种目标模式之一（物理或逻辑）。
— 目标字段——在物理目标模式下，用于指定目标处理器的 APIC ID；在逻辑目标模式下，用于指定消息目标地址（MDA），该地址可用于选择集群中的特定处理器。
— 目标速记——一种快速指定所有处理器、除自身外的所有处理器或自身作为目标的方法。
— 传递模式，最低优先级——指定使用最低优先级仲裁机制从指定的一组处理器中选择目标处理器。
• 本地目标寄存器（LDR）——与逻辑目标模式和 MDA 一起使用，以选择目标处理器。
• 目标格式寄存器（DFR）——与逻辑目标模式和 MDA 一起使用，以选择目标处理器。
ICR、LDR 和 DFR 如何用于选择 IPI 目标取决于所使用的目标模式：物理、逻辑、广播/自身或最低优先级传递模式。这些目标模式将在以下部分中描述。

### 8.6.2.1. 物理目标模式
在物理目标模式下，目标处理器由其本地 APIC ID 指定（见第 8.4.6 节，“本地 APIC ID”）。对于 Pentium 4 和 Intel Xeon 处理器，可以在物理目标模式下指定单个目标（本地 APIC ID 为 00H 到 FEH）或广播到所有 APIC（APIC ID 为 FFH）。这种 APIC ID 机制允许在单个系统总线上单独寻址多达 255 个本地 APIC。
对于 P6 家族和 Pentium 处理器，在物理目标模式下指定单个目标，本地 APIC ID 为 0H 到 0EH，允许在 APIC 总线上寻址多达 15 个本地 APIC。广播到所有本地 APIC 的指定为 0FH。
注意
系统总线上可以寻址的本地 APIC 的实际数量可能受硬件限制。

### 8.6.2.2. 逻辑目标模式
在逻辑目标模式下，IPI 目标使用 8 位消息目标地址（MDA）指定，该地址输入到 ICR 的目标字段中。当接收到使用逻辑目标模式发送的 IPI 消息时，本地 APIC 将消息中的 MDA 与其 LDR 和 DFR 中的值进行比较，以确定是否应接受并处理该 IPI。
图 8-13 显示了逻辑目标寄存器（LDR）的布局。该寄存器中的 8 位逻辑 APIC ID 字段用于创建可与 MDA 进行比较的标识符。
注意
逻辑 APIC ID 不应与本地 APIC ID 寄存器中包含的本地 APIC ID 混淆。

![](/static/images/2502/p080.png)


图 8-14 显示了目标格式寄存器（**DFR**）的布局。此寄存器中的 4 位模型字段选择在使用逻辑目标模式时可用于解释 MDA 的两种模型之一（平面或集群）。


![](/static/images/2502/p081.png)

以下段落描述了对两种模型的 MDA 的解释。

**平面模型**  
通过将 DFR 的第 28 至 31 位编程为 1111 来选择此模型。在此模型中，可以通过在 LDR 的逻辑 APIC ID 字段中为每个本地 APIC 设置不同的位来为最多 8 个本地 APIC 建立唯一的逻辑 APIC ID。然后，通过在 MDA 中设置一个或多个位来选择一组本地 APIC。

每个本地 APIC 对 MDA 和其逻辑 APIC ID 执行按位与操作。如果检测到真条件，则本地 APIC 接受 IPI 消息。通过将 MDA 设置为全 1，可以实现对所有 APIC 的广播。

**集群模型**  
通过将 DFR 的第 28 至 31 位编程为 0000 来选择此模型。此模型支持两种基本的目标方案：平面集群和分层集群。

平面集群目标模型仅支持 P6 家族和 Pentium 处理器。使用此模型时，假设所有 APIC 都通过 APIC 总线连接。MDA 的第 28 至 31 位包含目标集群的编码地址，第 24 至 27 位标识集群中的最多四个本地 APIC（每位分配给集群中的一个本地 APIC，如平面连接模型）。为了识别一个或多个本地 APIC，将 MDA 的第 28 至 31 位与 LDR 的第 28 至 31 位进行比较，以确定本地 APIC 是否属于该集群。将 MDA 的第 24 至 27 位与 LDR 的第 24 至 27 位进行比较，以识别集群中的本地 APIC。

可以通过在 MDA 的第 28 至 31 位中写入目标集群地址，并在 MDA 的第 24 至 27 位中设置与所选集群成员对应的位来指定集群中的处理器组。在此模式下，可以在消息中指定 15 个集群（集群地址为 0 到 14），每个集群有 4 个本地 APIC。然而，对于 P6 和 Pentium 处理器的本地 APIC，APIC 仲裁 ID 仅支持 15 个 APIC 代理，因此在此模式下支持的处理器及其本地 APIC 的总数限制为 15。通过将所有目标位设置为 1，可以实现对所有本地 APIC 的广播。这保证了所有集群的匹配，并选择每个集群中的所有 APIC。

**分层集群目标模型**  
此模型可用于 Pentium 4、Intel Xeon、P6 家族或 Pentium 处理器。通过此模型，可以通过独立的系统或 APIC 总线连接不同的平面集群，从而创建分层网络。此方案要求每个集群中有一个集群管理器，负责处理系统或 APIC 总线之间的消息传递。一个集群最多包含 4 个代理。因此，15 个集群管理器，每个有 4 个代理，可以形成一个最多 60 个 APIC 代理的网络。请注意，分层 APIC 网络需要特殊的集群管理器设备，该设备不属于本地或 I/O APIC 单元。

### 8.6.2.3. 广播/自身传递模式  
ICR 的目标速记字段允许绕过传递模式，直接将 IPI 广播到系统总线上的所有处理器和/或返回自身（见第 8.6.1 节，“中断命令寄存器 (ICR)”）。支持三种目标速记：自身、除自身外的所有处理器和包括自身在内的所有处理器。使用目标速记时，目标模式被忽略。

### 8.6.2.4. 最低优先级传递模式  
在最低优先级传递模式下，ICR 被编程为向系统总线上的多个处理器发送 IPI，使用逻辑或速记目标机制选择处理器。然后，所选处理器在系统总线或 APIC 总线上相互仲裁，最低优先级的处理器接受 IPI。

对于基于 Intel Xeon 处理器的系统，芯片组总线控制器接受系统中 I/O APIC 代理的消息，并将中断引导到系统总线上的处理器。当使用最低优先级传递模式时，芯片组从可能的目标集中选择一个目标处理器来接收中断。Pentium 4 处理器在系统总线上提供了一个特殊的总线周期，用于通知芯片组系统中每个逻辑处理器的当前任务优先级。芯片组保存此信息，并在接收到中断时使用它来选择最低优先级的处理器。

对于基于 P6 家族处理器的系统，用于最低优先级仲裁的处理器优先级包含在每个本地 APIC 的仲裁优先级寄存器 (APR) 中。图 8-15 显示了 APR 的布局。


![](/static/images/2502/p082.png)

**APR** 值的计算如下：  
```  
IF (TPR[7:4] ≥ IRRV[7:4]) AND (TPR[7:4] > ISRV[7:4])  
THEN  
APR[7:0] ← TPR[7:0]  
ELSE  
APR[7:4] ← max(TPR[7:4] AND ISRV[7:4], IRRV[7:4])  
APR[3:0] ← 0.  
```  
在这里，**TPR** 值是 **TPR** 中的任务优先级值（参见图 8-18），**IRRV** 值是 **IRR** 中设置的最高优先级位的向量号（参见图 8-20）或 **00H**（如果未设置 **IRR** 位），**ISRV** 值是 **ISR** 中设置的最高优先级位的向量号（参见图 8-20）。在目标处理器之间进行仲裁后，**APR** 值最低的处理器处理 IPI，其他处理器忽略它。

（仅限 P6 系列和 Pentium 处理器。）对于这些处理器，如果存在焦点处理器，它可能会接受中断，无论其优先级如何。如果处理器当前正在处理该中断或具有该中断的挂起请求，则称其为中断的焦点。对于 Intel Xeon 处理器，不支持焦点处理器的概念。

在使用最低优先级传递模式但不更新 **TPR** 的操作系统中，芯片组中保存的 **TPR** 信息可能会导致中断始终从逻辑集传递到同一处理器。这种行为在功能上与 P6 系列处理器向后兼容，但可能会导致意外的性能影响。

## 8.6.3. IPI 传递和接受  
当写入 **ICR** 的低双字时，本地 APIC 从 **ICR** 中包含的信息创建 IPI 消息，并将消息发送到系统总线（Pentium 4 和 Intel Xeon 处理器）或 APIC 总线（P6 系列和 Pentium 处理器）。这些 IPI 在发出后的处理方式在第 8.8 节“处理中断”中描述。