# 8.7. SYSTEM AND APIC BUS ARBITRATION

当多个本地 APIC 和 I/O APIC 在系统总线（或 APIC 总线）上发送 IPI 和中断消息时，消息的发送和处理顺序通过总线仲裁来确定。

对于 **Pentium 4 和 Intel Xeon 处理器**，本地 APIC 和 I/O APIC 使用为系统总线定义的仲裁机制来确定 IPI 的处理顺序。此机制是非架构的，无法通过软件控制。

对于 **P6 家族和 Pentium 处理器**，本地 APIC 和 I/O APIC 使用基于 APIC 的仲裁机制来确定 IPI 的处理顺序。在此机制中，每个本地 APIC 被分配一个从 0 到 15 的仲裁优先级，I/O APIC 在仲裁期间使用该优先级来确定哪个本地 APIC 应获得 APIC 总线的访问权限。具有最高仲裁优先级的本地 APIC 总是赢得总线访问权限。在一轮仲裁完成后，获胜的本地 APIC 将其仲裁优先级降低到 0，而失败的本地 APIC 则将其优先级提高 1。

本地 APIC 的当前仲裁优先级存储在一个 4 位、对软件透明的仲裁 ID（Arb ID）寄存器中。在复位期间，该寄存器被初始化为 APIC ID 号（存储在本地 APIC ID 寄存器中）。通过 ICR 命令发出的 **INIT 电平解除 IPI** 可用于重新同步本地 APIC 的仲裁优先级，方法是将每个代理的 Arb ID 寄存器重置为其当前的 APIC ID 值。（Pentium 4 和 Intel Xeon 处理器未实现 Arb ID 寄存器。）

第 8.10 节“APIC 总线消息传递机制和协议（仅限 P6 家族和 Pentium 处理器）”描述了 APIC 总线仲裁协议和总线消息格式，而第 8.6.1 节“中断命令寄存器 (ICR)”描述了 INIT 电平解除 IPI 消息。

需要注意的是，除了 SIPI IPI（见第 8.6.1 节“中断命令寄存器 (ICR)”），所有未能传递到指定目标或目标的总线消息都会自动重试。软件应避免将 IPI 发送到已禁用或不存在的本地 APIC 的情况，否则会导致消息被重复发送。