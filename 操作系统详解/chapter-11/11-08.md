# 8.8. HANDLING INTERRUPTS

当一个本地APIC接收到来自本地源的中断、来自I/O APIC的中断消息或IPI（处理器间中断）时，它处理该消息的方式取决于处理器的实现，如下文所述。

### 8.8.1. 使用Pentium 4和Intel Xeon处理器的中断处理
对于Pentium 4和Intel Xeon处理器，本地APIC处理其接收到的本地中断、中断消息和IPI的方式如下：
1. 它确定自己是否是指定的目标（见图8-16）。如果是指定的目标，则接受该消息；如果不是，则丢弃该消息。


![](/static/images/2502/p083.png)

2. 如果本地APIC确定自己是指定中断的目标，并且中断请求是NMI（不可屏蔽中断）、SMI（系统管理中断）、INIT（初始化中断）、ExtINT（外部中断）或SIPI（启动处理器间中断），则该中断将直接发送到处理器核心进行处理。  
3. 如果本地APIC确定自己是指定中断的目标，但中断请求不是第2步中提到的中断类型之一，则本地APIC会在中断请求寄存器（IRR）中设置相应的位。  
4. 当中断请求寄存器（IRR）和中断服务寄存器（ISR）中有挂起的中断时，本地APIC会根据它们的优先级以及任务优先级寄存器（TPR）和处理器优先级寄存器（PPR）中的当前任务和处理器优先级，逐个将中断分派给处理器（参见第8.8.3.1节，“任务和处理器优先级”）。  
5. 当一个固定中断被分派到处理器核心进行处理后，处理程序的完成通过在指令处理程序中写入本地APIC的中断结束（EOI）寄存器的指令来指示（参见第8.8.5节，“信号中断服务完成”）。写入EOI寄存器的操作会导致本地APIC从其ISR队列中删除该中断，并且（对于电平触发的中断）在总线上发送一条消息，表明中断处理已完成。（对于NMI、SMI、INIT、ExtINT或SIPI的中断处理程序中不得包含写入EOI寄存器的操作。）  

### 8.8.2. 使用P6系列和Pentium处理器的中断处理  
对于P6系列和Pentium处理器，本地APIC处理其接收到的本地中断、中断消息和IPI的方式如下（见图8-17）。

![](/static/images/2502/p084.png)

1. （仅适用于 IPI。）本地 APIC 检查 IPI 消息，以确定它是否是 IPI 的指定目标，如第 8.6.2 节“确定 IPI 目标”所述。如果它是指定目标，则继续其接受过程；如果不是目标，则丢弃 IPI 消息。当消息指定最低优先级传递模式时，本地 APIC 将与其他被指定为 IPI 消息接收者的处理器进行仲裁（见第 8.6.2.4 节“最低优先级传递模式”）。

2. 如果本地 APIC 确定它是中断的指定目标，并且中断请求是 NMI、SMI、INIT、ExtINT 或 INIT 解除中断，或者是 MP 协议 IPI 消息（BIPI、FIPI 和 SIPI）之一，则中断将直接发送到处理器核心进行处理。

3. 如果本地 APIC 确定它是中断的指定目标，但中断请求不是步骤 2 中列出的中断之一，则本地 APIC 会在其 IRR 和 ISR 寄存器中包含的两个挂起中断队列中寻找一个空闲槽位（见图 8-20）。如果有可用槽位（见第 8.8.4 节“固定中断的中断接受”），则将中断放入槽位。如果没有可用槽位，则拒绝中断请求并向发送者发送重试消息。

4. 当 IRR 和 ISR 寄存器中有挂起的中断时，本地 APIC 根据它们的优先级以及 TPR 和 PPR 中的当前任务和处理器优先级，逐个将它们分派给处理器（见第 8.8.3.1 节“任务和处理器优先级”）。

5. 当固定中断被分派到处理器核心进行处理时，处理程序的完成通过指令处理程序代码中的一条指令指示，该指令写入本地 APIC 中的中断结束（EOI）寄存器（见第 8.8.5 节“信号中断服务完成”）。写入 EOI 寄存器的操作会导致本地 APIC 从其队列中删除中断，并（对于电平触发的中断）在总线上发送一条消息，指示中断处理已完成。（NMI、SMI、INIT、ExtINT 或 SIPI 的处理程序代码中不得包含写入 EOI 寄存器的操作。）

以下部分将更详细地描述中断的接受及其由本地 APIC 和处理器的处理。

### 8.8.3. 中断、任务和处理器优先级
对于通过本地 APIC 传递到处理器的中断，每个中断都有一个基于其向量号的隐含优先级。本地 APIC 使用此优先级来确定相对于处理器其他活动（包括其他中断的服务）何时服务该中断。

对于向量号在 16 到 255 范围内的中断，中断优先级通过以下关系确定：
```
优先级 = 向量号 / 16
```
此处商数向下取整到最接近的整数值以确定优先级，1 为最低优先级，15 为最高优先级。由于向量 0 到 31 被 IA-32 架构保留用于专用用途，因此用户定义中断的优先级范围为 2 到 15。

每个中断优先级级别（有时被软件解释为中断优先级类别）包含 16 个向量。优先级级别内中断的优先级由向量号决定。向量号越高，该优先级级别内的优先级越高。在确定向量的优先级和优先级组内向量的排名时，向量号通常分为两部分，向量的高 4 位表示其优先级，低 4 位表示其在优先级组内的排名。

### 8.8.3.1. 任务和处理器优先级
本地 APIC 还定义了任务优先级和处理器优先级，用于确定中断的处理顺序。任务优先级是软件选择的值，范围在 0 到 15 之间（见图 8-18），并写入任务优先级寄存器（TPR）。TPR 是一个读/写寄存器。

![](/static/images/2502/p085.png)


**注意**  
在本讨论中，“任务”一词指的是由操作系统分派到处理器上运行的软件定义的任务、进程、线程、程序或例程。它并不指代第6章“任务管理”中描述的IA-32架构定义的任务。  

任务优先级允许软件为中断处理器设置一个优先级阈值。处理器只会服务那些优先级高于任务优先级寄存器（TPR）中指定值的中断。如果软件将TPR中的任务优先级设置为0，处理器将处理所有中断；如果将其设置为15，则除通过NMI、SMI、INIT、ExtINT、INIT解除和启动传递模式传递的中断外，所有中断均被禁止处理。这种机制使操作系统能够暂时屏蔽特定中断（通常是低优先级中断），以避免干扰处理器正在执行的高优先级工作。  

需要注意的是，任务优先级还用于确定本地处理器的仲裁优先级（参见第8.6.2.4节，“最低优先级传递模式”）。  

处理器优先级由处理器设置，其值也在0到15之间（见图8-19），并写入处理器优先级寄存器（PPR）。PPR是一个只读寄存器。处理器优先级表示处理器当前执行的优先级，用于确定挂起的中断是否可以分派给处理器。

![](/static/images/2502/p086.png)

PPR 中的值按以下方式计算：
```
IF TPR[7:4] ≥ ISRV[7:4]
THEN
PPR[7:0] ← TPR[7:0]
ELSE
PPR[7:4] ← ISRV[7:4]
PPR[3:0] ← 0
```
其中，ISRV 值是已设置的最高优先级 ISR 位的向量号，如果没有设置 ISR 位，则为 00H。本质上，处理器优先级被设置为 ISR 中最高优先级的挂起中断或当前任务优先级中的较高者。

### 8.8.4. 固定中断的中断接受
本地 APIC 将接受的固定中断排队到两个中断挂起寄存器之一：中断请求寄存器（IRR）或服务中寄存器（ISR）。这两个 256 位只读寄存器如图 8-20 所示。这些寄存器中的 256 位代表 256 个可能的向量，其中向量 0 到 15 被保留。

**注意**  
所有具有 NMI、SMI、INIT、ExtINT、启动或 INIT 解除传递模式的中断都会绕过 IRR 和 ISR 寄存器，并直接发送到处理器核心进行处理。


![](/static/images/2502/p087.png)

中断请求寄存器（IRR）包含已被接受但尚未分派给处理器进行服务的中断请求。当本地APIC接受一个中断时，它会在IRR中设置与接受的中断向量对应的位。当处理器核心准备好处理下一个中断时，本地APIC会清除IRR中已设置的最高优先级位，并设置中断服务寄存器（ISR）中相应的位。然后，ISR中最高优先级位对应的向量会被分派到处理器核心进行处理。

当处理器正在处理最高优先级中断时，本地APIC可以通过设置IRR中的位来发送额外的固定中断。当中断服务例程向中断结束（EOI）寄存器写入时（参见第8.8.5节，“信号中断服务完成”），本地APIC会清除ISR中已设置的最高优先级位。然后，它重复清除IRR中最高优先级位并设置ISR中相应位的过程。处理器核心随后开始执行ISR中最高优先级位对应的服务例程。

如果生成了多个具有相同向量号的中断，本地APIC可以在IRR和ISR中同时设置该向量的位。这意味着对于Pentium 4和Intel Xeon处理器，IRR和ISR可以为每个中断向量排队两个中断：一个在IRR中，一个在ISR中。为同一中断向量发出的任何额外中断将被合并到IRR中的单个位中。

对于P6系列和Pentium处理器，IRR和ISR寄存器在每个优先级级别上最多只能排队两个中断，并且会拒绝在同一优先级级别内接收的其他中断。

如果本地APIC接收到一个优先级高于当前正在处理的中断的中断，并且处理器核心中启用了中断，本地APIC会立即将更高优先级的中断分派给处理器（无需等待写入EOI寄存器）。当前正在执行的中断处理程序会被中断，以便处理更高优先级的中断。当更高优先级的中断处理完成后，被中断的中断处理会继续执行。

触发模式寄存器（TMR）指示中断的触发模式（见图8-20）。当中断被接受进入IRR时，对于边沿触发的中断，相应的TMR位会被清除；对于电平触发的中断，相应的TMR位会被设置。如果在生成其对应中断向量的EOI周期时设置了TMR位，则会向所有I/O APIC发送EOI消息。

### 8.8.5. 信号中断服务完成
对于除通过NMI、SMI、INIT、ExtINT、启动或INIT解除传递模式传递的中断之外的所有中断，中断处理程序必须包括对中断结束（EOI）寄存器的写入操作（见图8-21）。此写入操作必须在处理例程结束时、IRET指令之前的某个时间点进行。此操作表明当前中断的服务已完成，本地APIC可以从ISR中发出下一个中断。


![](/static/images/2502/p088.png)

当接收到 EOI 时，APIC 会清除 ISR 中最高优先级的位，并将下一个最高优先级的中断分派给处理器。如果被终止的中断是电平触发的中断，本地 APIC 还会向所有 I/O APIC 发送一条中断结束消息。

为了未来的兼容性，软件需要通过向 EOI 寄存器写入值 0H 来发出中断结束命令。