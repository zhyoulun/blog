# 8.11. MESSAGE SIGNALLED INTERRUPTS

《PCI本地总线规范》第2.2版（www.pcisig.com）引入了消息信号中断（Message Signalled Interrupts, MSI）的概念。目前支持此功能的英特尔处理器和芯片组包括Pentium 4和Intel Xeon处理器。如规范所述：

“消息信号中断（MSI）是一项可选功能，它使PCI设备能够通过向系统指定的地址（PCI DWORD内存写事务）写入系统指定的消息来请求服务。事务地址指定消息目的地，而事务数据指定消息内容。系统软件应在设备配置期间初始化消息目的地和消息内容，并为每个支持MSI的功能分配一个或多个非共享消息。”

《PCI本地总线规范》提供的功能机制用于识别和配置支持MSI的PCI设备。该结构包含多个字段，其中包括消息数据寄存器（Message Data Register）和消息地址寄存器（Message Address Register）。为了请求服务，PCI设备功能将消息数据寄存器的内容写入消息地址寄存器中包含的地址（对于64位消息地址，还包括消息高位地址寄存器）。

第8.11.1节和第8.11.2节提供了消息地址寄存器和消息数据寄存器的布局细节。设备发出的操作是对消息地址寄存器的PCI写命令，并附带消息数据寄存器的内容。该操作遵循为PCI写操作定义的语义规则，并且是一个DWORD操作。

### 8.11.1. 消息地址寄存器格式  
消息地址寄存器（低32位）的格式如图8-23所示。

![](/static/images/2502/p090.png)

消息地址寄存器中的字段如下：  

1. **第31-20位**：这些位包含中断消息的固定值（0FEEH）。该值将中断定位在基地址为4G – 18M的1MB区域内。对该区域的所有访问都被视为中断消息。必须注意确保没有其他设备将该区域声明为I/O空间。  

2. **目标ID**：该字段包含一个8位目标ID，用于标识消息的目标处理器。如果使用I/O APIC将中断分派给处理器，则该目标ID对应于I/O APIC重定向表项的第63:56位。  

3. **重定向提示指示（RH）**：该位指示消息是否应定向到能够接收中断的处理器中具有最低中断优先级的处理器。当该位为0时，中断定向到目标ID字段中列出的处理器。当该位为1时，中断定向到目标ID字段中指示的处理器中具有最低优先级的处理器。在解释目标ID字段以进行最低优先级传递时，会考虑DM位。  

4. **目标模式（DM）**：该位指示目标ID字段应解释为逻辑APIC ID还是物理APIC ID，以传递最低优先级中断。如果RH为1且DM为0，则目标ID字段处于物理目标模式，只有系统中具有匹配APIC ID的处理器会被考虑传递该中断（这意味着不会重定向）。如果RH为1且DM为1，则目标ID字段被解释为逻辑目标模式，重定向仅限于基于处理器的逻辑APIC ID和消息中的目标ID字段的逻辑处理器组中的处理器。逻辑处理器组由与目标格式寄存器和每个本地APIC中的逻辑目标寄存器标识的逻辑目标匹配的8位目标ID标识的处理器组成。详细信息类似于第8.6.2节“确定IPI目标”中的描述。如果RH为0，则忽略DM位，消息将独立于使用物理目标模式还是逻辑目标模式发送。  

### 8.11.2. 消息数据寄存器格式  
消息数据寄存器的布局如图8-24所示。

![](/static/images/2502/p091.png)

保留字段的值不假定为任何特定值。软件在写入时必须保留其内容。消息数据寄存器中的其他字段描述如下：

1. **向量（Vector）**：  
   这个8位字段包含与消息关联的中断向量。值范围为010H到0FEH。软件必须确保该字段未被编程为00H到0FH的向量。

2. **传递模式（Delivery Mode）**：  
   这个3位字段指定如何处理中断接收。传递模式仅与指定的触发模式结合使用。软件必须保证正确的触发模式。具体限制如下：  
   a. **000B（固定模式，Fixed Mode）** – 将信号传递给目标字段中列出的所有代理。固定传递模式的触发模式可以是边沿或电平。  
   b. **001B（最低优先级，Lowest Priority）** – 将信号传递给目标字段中列出的所有代理中执行优先级最低的代理。触发模式可以是边沿或电平。  
   c. **010B（系统管理中断，SMI）** – 传递模式仅为边沿触发。对于依赖SMI语义的系统，向量字段被忽略，但必须编程为全零以确保未来兼容性。  
   d. **100B（不可屏蔽中断，NMI）** – 将信号传递给目标字段中列出的所有代理。向量信息被忽略。无论触发模式设置如何，NMI都是边沿触发中断。  
   e. **101B（初始化中断，INIT）** – 将此信号传递给目标字段中列出的所有代理。向量信息被忽略。无论触发模式设置如何，INIT都是边沿触发中断。  
   f. **111B（外部中断，ExtINT）** – 将信号传递给目标字段中所有代理的INTR信号（作为源自8259A兼容中断控制器的中断）。向量由ExtINT激活时发出的INTA周期提供。ExtINT是边沿触发中断。

3. **电平（Level）**：  
   边沿触发的中断消息始终被解释为断言消息。对于边沿触发中断，此字段未使用。对于电平触发中断，此位反映中断输入的状态。

4. **触发模式（Trigger Mode）**：  
   此字段指示触发消息的信号类型。  
   a. **0** – 表示边沿敏感。  
   b. **1** – 表示电平敏感。