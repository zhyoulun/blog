# 系统级架构概览

IA-32系统级架构由一组寄存器、数据结构和指令组成，旨在支持基本的系统级操作，如内存管理、中断和异常处理、任务管理以及多处理器（多处理）控制。图2-1提供了系统寄存器和数据结构的概括性总结。


![](/static/images/2502/p021.png)

> todo：下述内容还没有仔细review

undefined### 2.1.1. 全局描述符表和局部描述符表  
在保护模式下操作时，所有内存访问都通过全局描述符表（GDT）或（可选的）局部描述符表（LDT）进行，如图2-1所示。这些表包含称为段描述符的条目。段描述符提供段的基地址以及访问权限、类型和使用信息。每个段描述符都有一个与之关联的段选择子。段选择子提供GDT或LDT的索引（指向其关联的段描述符）、全局/局部标志（确定段选择子指向GDT还是LDT）以及访问权限信息。

要访问段中的某个字节，必须提供段选择子和偏移量。段选择子提供对段描述符的访问（在GDT或LDT中）。处理器从段描述符中获取段在线性地址空间中的基地址。偏移量则提供字节相对于基地址的位置。只要段可以从处理器当前运行的权限级别（CPL）访问，此机制可用于访问GDT或LDT中的任何有效代码、数据或堆栈段。（CPL定义为当前执行代码段的保护级别。）

在图2-1中，实线箭头表示线性地址，虚线表示段选择子，点线箭头表示物理地址。为简化起见，许多段选择子被显示为直接指向段的指针。然而，从段选择子到其关联段的实际路径始终通过GDT或LDT。

GDT基地址的线性地址包含在GDT寄存器（GDTR）中；LDT的线性地址包含在LDT寄存器（LDTR）中。

### 2.1.2. 系统段、段描述符和门  
除了构成程序或过程执行环境的代码、数据和堆栈段外，系统架构还定义了两个系统段：任务状态段（TSS）和LDT。（GDT不被视为段，因为它不是通过段选择子和段描述符访问的。）每种段类型都有为其定义的段描述符。

系统架构还定义了一组称为门（调用门、中断门、陷阱门和任务门）的特殊描述符，它们为系统过程和处理器提供受保护的网关，这些过程和处理器运行在与应用程序和过程不同的权限级别。

例如，通过调用门进行的CALL操作可以访问与当前代码段权限级别相同或数值更低（权限更高）的代码段中的过程。要通过调用门访问过程，调用过程必须提供调用门的选择子。处理器随后对调用门执行访问权限检查，比较CPL与调用门的权限级别以及调用门指向的目标代码段。如果允许访问目标代码段，处理器从调用门中获取目标代码段的段选择子和偏移量。

如果调用需要权限级别的更改，处理器还会切换到该权限级别的堆栈。（新堆栈的段选择子从当前运行任务的TSS中获取。）门还促进了16位和32位代码段之间的转换，反之亦然。

### 2.1.3. 任务状态段和任务门  
TSS（见图2-1）定义了任务的执行环境状态。它包括通用寄存器、段寄存器、EFLAGS寄存器、EIP寄存器的状态，以及三个堆栈段（分别为权限级别0、1和2）的段选择子和堆栈指针。它还包括与任务关联的LDT的段选择子和页表基地址。

在保护模式下，所有程序执行都在称为当前任务的任务上下文中进行。当前任务的TSS的段选择子存储在任务寄存器中。切换到任务的最简单方法是调用或跳转到任务。在这里，新任务的TSS的段选择子在CALL或JMP指令中给出。在切换任务时，处理器执行以下操作：  
1. 将当前任务的状态存储在当前TSS中。  
2. 将任务寄存器加载为新任务的段选择子。  
3. 通过GDT中的段描述符访问新TSS。  
4. 从新TSS中将新任务的状态加载到通用寄存器、段寄存器、LDTR、控制寄存器CR3（页表基地址）、EFLAGS寄存器和EIP寄存器中。  
5. 开始执行新任务。

任务也可以通过任务门访问。任务门类似于调用门，但它提供对TSS的访问（通过段选择子）而不是代码段。

### 2.1.4. 中断和异常处理  
外部中断、软件中断和异常通过中断描述符表（IDT）处理，见图2-1。IDT包含一组门描述符，它们提供对中断和异常处理程序的访问。与GDT一样，IDT不是段。IDT基地址的线性地址包含在IDT寄存器（IDTR）中。

IDT中的门描述符可以是中断门、陷阱门或任务门类型。要访问中断或异常处理程序，处理器必须首先从内部硬件、外部中断控制器或通过INT、INTO、INT 3或BOUND指令从软件接收中断向量（中断号）。中断向量提供IDT中门描述符的索引。如果选定的门描述符是中断门或陷阱门，则以类似于通过调用门调用过程的方式访问关联的处理程序。如果描述符是任务门，则通过任务切换访问处理程序。

### 2.1.5. 内存管理  
系统架构支持直接物理内存寻址或虚拟内存（通过分页）。当使用物理寻址时，线性地址被视为物理地址。当使用分页时，所有代码、数据、堆栈和系统段以及GDT和IDT都可以分页，只有最近访问的页面保留在物理内存中。

物理内存中页面（或有时在IA-32架构中称为页框）的位置包含在两种类型的系统数据结构中（页目录和一组页表），它们都驻留在物理内存中（见图2-1）。页目录中的条目包含页表基地址的物理地址、访问权限和内存管理信息。页表中的条目包含页框的物理地址、访问权限和内存管理信息。页目录的基物理地址包含在控制寄存器CR3中。

要使用此分页机制，线性地址被分为三部分，分别提供页目录、页表和页框的偏移量。

系统可以有一个或多个页目录。例如，每个任务可以有自己的页目录。

### 2.1.6. 系统寄存器  
为了协助初始化处理器和控制系统操作，系统架构在EFLAGS寄存器中提供了系统标志和几个系统寄存器：  
- EFLAGS寄存器中的系统标志和IOPL字段控制任务和模式切换、中断处理、指令跟踪和访问权限。有关这些标志的描述，请参见第2.3节“EFLAGS寄存器中的系统标志和字段”。  
- 控制寄存器（CR0、CR2、CR3和CR4）包含用于控制系统级操作的各种标志和数据字段。这些寄存器中的其他标志用于指示操作系统或执行程序中特定处理器功能的支持。有关这些标志的描述，请参见第2.5节“控制寄存器”。  
- 调试寄存器（未在图2-1中显示）允许设置断点以用于调试程序和系统软件。有关这些寄存器的描述，请参见第15章“调试和性能监控”。  
- GDTR、LDTR和IDTR寄存器包含其各自表的线性地址和大小（限制）。有关这些寄存器的描述，请参见第2.4节“内存管理寄存器”。  
- 任务寄存器包含当前任务的TSS的线性地址和大小。有关此寄存器的描述，请参见第2.4节“内存管理寄存器”。  
- 型号特定寄存器（未在图2-1中显示）。  
型号特定寄存器（MSR）是一组主要供操作系统或执行程序（即在权限级别0运行的代码）使用的寄存器。这些寄存器控制调试扩展、性能监控计数器、机器检查架构和内存类型范围（MTRR）等项目。

有关MSR的更多信息，请参见第9.4节“型号特定寄存器（MSR）”，以及附录B“型号特定寄存器（MSR）”以获取完整的MSR列表。

大多数系统限制应用程序访问所有系统寄存器（EFLAGS寄存器除外）。然而，可以设计所有程序和过程在最高权限级别（权限级别0）运行的系统，在这种情况下，允许应用程序修改系统寄存器。

### 2.1.7. 其他系统资源  
除了前面几节描述的系统寄存器和数据结构外，系统架构还提供了以下额外资源：  
- 操作系统指令（参见第2.6节“系统指令摘要”）。  
- 性能监控计数器（未在图2-1中显示）。  
- 内部缓存和缓冲区（未在图2-1中显示）。  

性能监控计数器是可编程的事件计数器，用于计数处理器事件，如解码的指令数量、接收的中断数量或缓存加载次数。有关这些计数器的更多信息，请参见第15.8节“性能监控概述”。

处理器提供了多个内部缓存和缓冲区。缓存用于存储数据和指令。缓冲区用于存储解码的地址到系统和应用程序段以及等待执行的写操作等内容。有关处理器缓存和缓冲区的详细讨论，请参见第10章“内存缓存控制”。